# Clusters, Shards and Replicas

## 1. Общая идея распределённого деплоя

Когда объём данных превышает возможности одной машины или требуется высокая отказоустойчивость, Qdrant можно развернуть в кластерном режиме. Ключевые механизмы — **шардинг**, **репликация** и **консенсус**.

---

## 2. Шард (Shard)

- **Shard** — это часть коллекции, которая хранит подмножество точек.
- При создании коллекции можно задать `shard_number` — количество шардов.
- Точки распределяются по шардам (обычно хэш-функцией от `point_id`).

### Выбор `shard_number`

- Для маленьких коллекций (до десятков миллионов точек) достаточно 1–2 шардов.
- Для больших коллекций (>100M точек) рекомендуется больше шардов, чтобы распределить нагрузку по узлам.
- Правило: чем больше узлов в кластере и чем больше коллекция, тем выше `shard_number`.

---

## 3. Репликация (Replica)

- **Replica** — копия одного и того же шарда на другом узле.
- Реплики повышают отказоустойчивость и масштабирование чтения.
- Можно задать `replication_factor` при создании коллекции.
- Запись отправляется на все реплики, чтение — на любую (или несколько для согласованности).

---

## 4. Консистентность

- Qdrant использует **конфигурируемую консистентность**:
  - **Strong** — данные считаются записанными, только если подтверждены всеми репликами.
  - **Weak** — достаточно подтверждения от одной реплики.
  - **Quorum** — большинство реплик должны подтвердить запись.
- Это позволяет балансировать между скоростью и надёжностью.

---

## 5. Raft-консенсус

- Для управления кластером и распределения метаданных используется **Raft**.
- Raft обеспечивает:
  - выбор лидера (координирующего узла),
  - согласованное хранение состояния коллекций и шардов,
  - автоматический фейловер (если лидер упал, выбирается новый).
- Raft используется для метаданных, а не для векторного поиска.

---

## 6. Отказоустойчивость

- При падении узла с репликой:
  - кластер продолжает работу за счёт оставшихся реплик,
  - при восстановлении узел подтягивает данные с других.
- При падении узла с единственным шардом (без реплик) данные теряются.
- Поэтому **минимум одна реплика на шард** рекомендуется для продакшена.

---

## 7. Пример конфигурации коллекции с шардами и репликами

```python
from qdrant_client.http import models as rest

client.recreate_collection(
    collection_name="big_docs",
    vectors_config={"vector": rest.VectorParams(size=768, distance=rest.Distance.COSINE)},
    shard_number=4,              # 4 шарда
    replication_factor=2,        # каждая часть хранится на 2 узлах
    write_consistency_factor=2   # запись подтверждается обоими
)
```

---
