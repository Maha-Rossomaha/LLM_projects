# Indexing Optimizer

## 1. Виды индексов

Qdrant поддерживает два основных типа индексов:

### Векторные индексы

* **HNSW** — основной ANN-алгоритм в Qdrant.

  * Параметры:

    * `m` — количество связей каждой вершины графа (чем больше, тем выше точность, но растёт память и время построения);
    * `ef_construct` — глубина построения графа, влияет на качество индексации и время её выполнения;
    * `ef_search` — глубина поиска во время запроса, влияет на баланс скорость/recall (чем выше, тем лучше качество, но выше задержка).

      * Дает быстрый поиск при высоком recall.
* **Plain (Brute-force)** — линейный перебор.

  * Используется для маленьких коллекций или пока сегмент не оптимизирован.

### Индексы по payload

* **Строковые** — тип `KEYWORD`.
* **Числовые** — `INTEGER`, `FLOAT`.
* **Гео-поля** — `GEO`.
* **Булевы** — как ключевые слова.

Создание индекса:

```python
client.create_payload_index(
    collection_name="docs",
    field_name="lang",
    field_schema=rest.PayloadSchemaType.KEYWORD
)
```

---

## 2. Оптимизатор сегментов

Qdrant хранит данные в сегментах. Оптимизатор управляет их слиянием и пересборкой.

### Задачи оптимизатора

* **Слияние сегментов** — объединяет маленькие сегменты в крупные.
* **Перестройка индекса** — строит HNSW для сегмента при достижении порога.
* **Удаление старых версий** — «вакуум», удаление неактуальных точек.
* **Контроль RAM и latency** — балансирует между скоростью вставки и скоростью поиска.

---

## 3. Параметры оптимизации

Настраиваются через `OptimizersConfigDiff`.

* `deleted_threshold` — порог удалённых точек в сегменте (триггер на пересборку).
* `vacuum_min_vector_number` — минимальное число векторов для запуска вакуума.
* `max_segment_size` — максимальный размер сегмента.
* `memmap_threshold` — порог размера, после которого сегмент маппится на диск (экономия RAM).
* `default_segment_number` — сколько сегментов создавать изначально.

Пример настройки:

```python
from qdrant_client.http import models as rest

client.update_collection(
    collection_name="docs",
    optimizers_config=rest.OptimizersConfigDiff(
        deleted_threshold=0.2,
        vacuum_min_vector_number=1000,
        max_segment_size=100_000,
        memmap_threshold=20000
    )
)
```

---

## 4. Когда пересобирается индекс

* При достижении лимита сегмента.
* При превышении порога удалённых точек (`deleted_threshold`).
* При ручном вызове `recreate_collection` или `update_collection` с новыми параметрами индекса.
* В фоне при работе оптимизатора.

---

## 5. Вакуум

* «Вакуум» = очистка удалённых или устаревших точек.
* Запускается при превышении порога удалённых точек или вручную.
* Уменьшает размер хранилища, но может временно увеличить нагрузку.

---

## 6. Влияние на задержки и RAM

* **Слияние сегментов** и **перестройка индекса** происходят в фоне, но могут увеличить нагрузку на CPU.
* Во время оптимизации латентность может вырасти.
* `memmap_threshold` снижает RAM-использование, но замедляет доступ к диску.
* Большие `ef_search` увеличивают recall, но требуют больше RAM и времени на запрос.
