# Troubleshooting

## 1. «Не находится через фильтр»

**Симптомы:** поиск по вектору работает, но при добавлении фильтра (`must`, `match`) результаты пустые.

**Диагностика:**

1. Проверить, создан ли индекс на поле payload (`create_payload_index`).
2. Убедиться, что тип индекса соответствует данным (строка → KEYWORD, число → INTEGER/FLOAT).
3. Проверить фактическое наличие ключа в payload (`retrieve`).

**Фикс:**

- Создать индекс на поле.
- Привести значения к правильному типу.
- Проверить вложенные JSON-ключи (Qdrant не ищет по вложенным без указания ключа).

---

## 2. «RAM улетает»

**Симптомы:** Qdrant быстро потребляет всю память, система уходит в swap.

**Диагностика:**

1. Проверить размер сегментов (`/collections/{name}` → `segments`).
2. Убедиться, что включён `memmap_threshold`.
3. Сравнить количество загруженных векторов с RAM.

**Фикс:**

- Настроить `memmap_threshold`, чтобы большие сегменты маппились на диск.
- Ограничить `max_optimizers_threads`, чтобы оптимизация не ела память.
- Добавить RAM или уменьшить размер коллекции.

---

## 3. «Медленный апдейт»

**Симптомы:** операции `upsert` или `set_payload` выполняются медленно.

**Диагностика:**

1. Проверить нагрузку на оптимизатор (слияния сегментов).
2. Проверить количество реплик (update выполняется на всех).
3. Убедиться, что batch не слишком большой (>10k точек).

**Фикс:**

- Делать обновления батчами по 1k–5k точек.
- Включить асинхронный ingestion.
- Отрегулировать параметры оптимизатора (`max_segment_size`, `vacuum_min_vector_number`).

---

## 4. «Падение QPS при оптимизации»

**Симптомы:** во время фоновой оптимизации (слияние сегментов, перестройка индекса) падает производительность.

**Диагностика:**

1. Посмотреть логи — происходят ли compaction/merge.
2. Проверить, сколько потоков выделено оптимизатору.

**Фикс:**

- Ограничить число потоков для оптимизации.
- Планировать heavy ingestion ночью.
- Увеличить `max_segment_size`, чтобы оптимизации запускались реже.

---

## 5. «Рассинхрон в кластере»

**Симптомы:** данные видны на одной реплике, но не на другой; результаты поиска отличаются.

**Диагностика:**

1. Проверить статус кластера (`/cluster`).
2. Убедиться, что реплика подтянула данные.
3. Посмотреть состояние Raft-консенсуса.

**Фикс:**

- Подождать, пока реплика догонит (обычно автоматически).
- Перезапустить отстающий узел.
- Проверить `write_consistency_factor`: для strong/quorum рассинхрона быть не должно.

---

## 6. Общие приёмы диагностики

- Использовать `/collections/{name}` и `/cluster` для статуса.
- Включать логирование на уровне DEBUG для отладки.
- Использовать мониторинг (p95 latency, QPS, оптимизации).
