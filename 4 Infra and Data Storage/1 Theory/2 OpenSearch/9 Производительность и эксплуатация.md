# Производительность и эксплуатация&#x20;

Ключевые аспекты эксплуатации и повышения производительности OpenSearch:

* шардирование и реплики,
* управление обновлением индексов (refresh, flush, merge),
* кэширование,
* мониторинг состояния,
* тюнинг поисковых запросов.

---

## 1. Шардинг и реплики

### 1.1. Первичные шард и реплики

* Каждый индекс разбивается на **N primary shards**.
* Каждая primary shard может иметь **M replica shards** (копий).

Пример:

```json
PUT /my-index
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1
  }
}
```

Это создаёт 3 primary и 3 replica (всего 6 шардов).

### 1.2. Когда менять `number_of_shards`

* **Только при создании** индекса.
* Лучше использовать **rollover** и шаблоны с префиксами.
* Оптимально: 1 шард ≈ 10–50 ГБ.

---

## 2. Refresh / Flush / Merge

### 2.1. Refresh

* Делает данные **доступными для поиска**.
* Происходит **по умолчанию каждые 1 секунду**.
* Можно отключить авто-refresh:

```json
"refresh_interval": -1
```

### 2.2. Flush

* Сбрасывает транзакционный лог в сегменты.
* Уменьшает использование памяти.
* Выполняется фоном или вручную:

```bash
POST /my-index/_flush
```

### 2.3. Merge

* Объединяет сегменты в один (меньше файлов → быстрее поиск).
* Происходит фоново.
* Можно вызвать вручную (например, перед архивацией):

```bash
POST /my-index/_forcemerge?max_num_segments=1
```

---

## 3. Кэширование

### 3.1. Query cache

* Кэширует только **filter-запросы** (term/range/exists).
* Не кэширует full-text и агрегации.
* Автоматически используется, если `filter_context`.

### 3.2. Request cache

* Кэширует **результат всего запроса** (если нет `from/size`).
* Полезен для **агрегаций** на неизменяемых данных.

```json
"request_cache": true
```

### 3.3. Aggs cache в OpenSearch 2.10+

* Новая экспериментальная фича — кэш агрегаций.

---

## 4. Мониторинг

### 4.1. `_cat` API

```bash
GET _cat/indices?v
GET _cat/shards?v
GET _cat/nodes?v&h=ip,heapPercent,cpu,load_1m,uptime,nodeRole
```

### 4.2. `_cluster/health`

```bash
GET _cluster/health?pretty=true
```

### 4.3. `_pending_tasks`

* Отложенные задания (например, перемещение реплик).

```bash
GET _cluster/pending_tasks
```

### 4.4. `/_nodes/stats`

* Статистика по памяти, GC, CPU и I/O.

---

## 5. Тюнинг поиска

### 5.1. `track_total_hits`

* По умолчанию считает **все** совпадения.
* Можно ограничить:

```json
"track_total_hits": 10000
```

### 5.2. `terminate_after`

* Прерывает выполнение после N совпадений:

```json
"terminate_after": 1000
```

### 5.3. `profile`

* Подробный разбор времени выполнения:

```bash
POST /my-index/_search
{
  "profile": true,
  "query": { "match_all": {} }
}
```
