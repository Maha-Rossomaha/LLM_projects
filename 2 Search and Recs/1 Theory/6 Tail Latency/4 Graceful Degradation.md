# Graceful Degradation

## 1. Жёсткие таймауты по этапам

### 1.1. Пер‑stage таймауты

Используем latency budget из SLO и декомпозиции пайплайна:

- `timeout_ann` — не более X мс,
- `timeout_rerank` — не более Y мс,
- `timeout_llm` — не более Z мс.

Пример:
- SLO: $p95(T_{total}) \le 400 \text{мс},\ p99 \le 800 \text{мс}$.
- Бюджеты:
  - ANN ≤ 80–100 мс,
  - rerank ≤ 120–150 мс,
  - LLM (если есть) ≤ 250–400 мс.

Таймауты ставят чуть **шире** бюджета, чтобы не рубить «нормальные» запросы:
- budget_ann = 80 мс → timeout_ann = 120 мс,
- budget_rerank = 120 мс → timeout_rerank = 180 мс,
- budget_llm = 300 мс → timeout_llm = 400–500 мс.

### 1.2. Уровни таймаутов

Таймауты обычно есть на трёх уровнях:

1. **Внутри каждого сервиса**
   - ANN‑узел сам ограничивает внутренние операции;
   - reranker/LLM прерывают вычисления, если не успевают.

2. **На уровне оркестратора/агрегатора**
   - общий таймаут на этап;
   - если этап не ответил вовремя, оркестратор идёт по пути деградации.

3. **Глобальный таймаут на запрос**
   - даже если внутренние таймауты не сработали, весь запрос не может жить больше N мс/секунд.

---

## 2. Поведение при срабатывании таймаута

Когда таймаут срабатывает, важно **не просто упасть с ошибкой**, а корректно деградировать.

Типовые варианты:

### 2.1. Отдаём частичный результат

Применимо, если часть пайплайна уже дала полезные данные.

Примеры:
- ANN успел вернуть top‑K, но rerank не успел → отдаём ANN‑ранжировку.
- LLM сгенерировал первые N токенов и упёрся в лимит → отдаём то, что есть + пометка/ссылка.

### 2.2. Пропускаем дорогой слой

Если таймаут сработал на «тяжёлом» этапе:

- неуспевший rerank → возвращаем bi‑encoder top‑K (или предыдущий ранк);
- неуспевший сложный reranker → включаем простой rule‑based или быстрый ML.

Идея: **лучше чуть хуже ранжировка, чем отсутствие ответа**.

### 2.3. Fallback на простой ответ

Если всё совсем плохо (LLM «лежит», ANN не отвечает):

- отдаём FAQ / template‑ответ,
- показываем заранее подготовленную подсказку,
- используем закэшированные результаты.

Примеры:
- «Сервис временно перегружен, вот краткий ответ и ссылка на полный FAQ»;
- «По вашему вопросу есть готовая инструкция, вот выдержка + кнопка “подробнее”».

### 2.4. Не забыть логировать

Каждое срабатывание таймаута должно логироваться:
- какой этап,
- какие параметры запроса (длина, фильтры и т.п.),
- какой fallback применён.

Иначе нельзя будет понять, насколько часто и для кого вы на самом деле деградируете.

---

## 3. Примеры стратегий graceful degradation

### 3.1. «Если не успел reranker → отдаём bi‑encoder top‑K»

**Сценарий**
- ANN выдаёт 200 кандидатов.
- Reranker — тяжёлый cross‑encoder, бюджет 150 мс, timeout 200 мс.

**Стратегия**
1. До timeout_rerank:
   - если rerank успел → возвращаем cross‑encoder top‑K.
2. После timeout_rerank:
   - возвращаем simple bi‑encoder top‑K (или raw ANN top‑K);
   - можно слегка поправить правилами (фильтры, бизнес‑приоритеты).

**Интуиция**
- bi‑encoder хуже по качеству, но **предсказуем по latency**;
- хвост cross‑encoder’а не убивает UX, потому что есть быстрый запасной вариант.

### 3.2. «Если LLM тормозит → краткий ответ/FAQ + ссылка»

**Сценарий**
- RAG‑бот, LLM обычно отвечает за 1–2 секунды, но иногда может думать 5–10.
- timeout_llm = 3 секунды.

**Стратегия**
1. Пока не истёк timeout_llm:
   - стримим токены пользователю.
2. Как только истёк timeout_llm (или достигнут лимит токенов):
   - прекращаем генерацию,
   - добавляем хвостом: «Вот краткий ответ, за подробностями — сюда: <ссылка на FAQ/док>»;
   - или отдаём заранее подготовленный summary.

**Вариант чуть сложнее**
- параллельно с LLM‑ответом считаем retrieval‑only fallback: top‑K документов + простое rule‑based summary;
- если LLM не успевает — отдаём fallback версию.

### 3.3. «Если ANN не успевает → fallback на кэш/узкий поиск»

**Сценарий**
- ANN иногда уезжает в хвост из‑за hot‑sharda.

**Стратегия**

1. Если ANN уложился в timeout_ann → обычный путь.
2. Если нет →
   - пытаемся взять результат из кэша для похожего запроса/того же пользователя;
   - или делаем быстрый fallback:
     - локальный inverted index,
     - поиск только по head‑объектам,
     - готовые “популярное сейчас”/“частые вопросы”.

Так пользователь всё равно получает осмысленный ответ, пусть и менее персонализированный.

---

## 4. Как выбирать уровни деградации

Важно заранее определить **ступени**:

1. **Основной режим**
   - всё успевает в бюджет;
   - полный пайплайн: ANN → heavy rerank → LLM full answer.

2. **Лёгкая деградация**
   - не успел rerank → отдаём быстрый ранк;
   - LLM урезан по длине/детализации.

3. **Сильная деградация**
   - ANN fallback (кэш/узкий поиск);
   - LLM выключен, только FAQ/темплейты.

Для каждой ступени:
- чётко описано, **что именно меняется** в ответе,
- заданы **ограничения по доле** запросов, которые могут туда попадать (например, не более 1–2%).

---

## 5. Мониторинг и риски

### 5.1. Что мониторить

1. p95/p99 по этапам и total.
2. Долю запросов, где:
   - сработал timeout_ann / timeout_rerank / timeout_llm,
   - применён fallback по каждой ступени.
3. Бизнес‑метрики по деградировавшим запросам:
   - CTR, досмотры, жалобы, повторные запросы.

Если доля деградации растёт или бизнес‑метрики по этим запросам сильно хуже — это сигнал, что система работает на пределе.

### 5.2. Основные риски

1. **Тихое ухудшение качества**
   - если не мониторить отдельный слой «деградировавших» запросов, можно не заметить, что 10% трафика уже живёт на fallback.

2. **Случайная асимметрия по сегментам**
   - таймауты чаще срабатывают, например, у конкретного региона или типа запросов → для них качество системно хуже.

3. **Слишком жёсткие таймауты**
   - если сделать их сильно меньше реальных бюджетов, система почти всегда будет возвращать упрощённые ответы.


