# Retrain Cadence

## 0. Мотивация

Модель в проде живёт в реальном мире, который меняется.

Если не переобучать — она устаревает:

* падает качество,
* появляются «слепые зоны» (новые типы объектов/запросов),
* растёт бизнес‑ущерб.

Если переобучать слишком часто — ты:

* тратишь compute,
* рискуешь регрессией на шуме,
* усложняешь валидацию и раскатку.

**Retrain cadence** — это баланс между «свежестью» и «стабильностью».

---

## 1. Периодичность (cadence)

### 1.1. Базовый выбор

На старте почти всегда задают **регулярный ритм**, а потом добавляют триггеры.

Типовые ритмы:

* **Realtime / streaming**: модель почти непрерывно дообучается (редко нужно для эмбеддингов).
* **Daily**: быстро меняющиеся домены (новости, фиды, антиспам).
* **Weekly**: маркетплейс/соцсеть, быстрый оборот контента.
* **Monthly/Quarterly**: кредитные/рисковые/бизнес‑ядра, где важнее стабильность и контроль.

### 1.2. Что влияет на cadence

1. **Скорость дрейфа**.

   * если интересы/ассортимент меняются за неделю → нельзя переобучать раз в квартал.
2. **Сезонность**.

   * перед НГ/чёрной пятницей cadence иногда ускоряют.
3. **Стоимость ошибки**.

   * если регрессия бьёт по деньгам/безопасности → лучше реже, но аккуратнее.
4. **Доступность лейблов**.

   * если лейблы “вызревают” месяц → cadence < месяца бессмысленна.

### 1.3. Практическое правило

Cadence выбирают так:

* **регулярно** переобучаемся чуть *реже*, чем типичное время дрейфа,
* а **триггеры** ловят неожиданные ситуации раньше.

---

## 2. Критерии запуска переобучения

Есть два класса критериев:

1. **Hard triggers** — мир изменился *физически*, модель обязана обновиться.
2. **Soft triggers** — качество поползло вниз, но возможно это шум.

Почти всегда работает связка:

* hard trigger → **обязательный retrain**, минуя споры,
* soft trigger → retrain **после подтверждения** (CI/сегменты/длительность ухудшения).

---

## 3. Hard triggers (change of data distribution)

### 3.1. Смысл

Hard trigger — это когда изменилась **поставка данных** так, что модель *по определению* стала невалидной.

Это не про «стало хуже», а про «мы теперь живём в другом мире».

### 3.2. Типы hard triggers

1. **Смена распределения входов** (feature drift / domain shift).

   * новый тип товаров/контента,
   * массовый приход новой аудитории,
   * смена языка/региона.

2. **Смена схемы/логики признаков**.

   * добавили/удалили важную фичу,
   * поменяли нормализацию,
   * изменили правила генерации данных.

3. **Инфраструктурная миграция**.

   * новый encoder,
   * новый токенизатор,
   * новая версия пайплайна разметки.

### 3.3. Как детектировать

* статистические тесты на фичи:

  * PSI, KS‑test, JS‑divergence, Wasserstein,
  * “feature health” по сегментам.
* мониторинг распределений для ключевых фич/эмбеддингов.

Hard trigger формулируется как «нарушение инварианта».
Например:

* PSI > 0.2 на ядре признаков 3 дня подряд,
* доля нового доменного класса > 15% в потоке.

### 3.4. Бизнес‑примеры

**Маркетплейс.**
Появилась новая категория (например, “умные кольца”), которой раньше не было. Векторное пространство старой модели не умеет их размещать. Это hard trigger.

**Антиспам.**
Вышел новый спам‑паттерн (формат ссылок/эмодзи/язык), и его доля стала существенной. Нельзя ждать падения метрик — сразу retrain.

---

## 4. Soft triggers (quality degradation)

### 4.1. Смысл

Soft trigger — это «модель стала хуже», но:

* возможно временный шум,
* возможно эффект на одном сегменте,
* возможно проблема не в модели (например, сломался фильтр).

Поэтому soft triggers требуют подтверждения.

### 4.2. Что мониторят

Для retriever/эмбеддингов:

* ΔRecall@K, ΔnDCG@K (оффлайн/шадоу),
* coverage / empty‑results rate,
* бизнес‑прокси: CTR/досмотры/скрытия,
* метрики стабильности эмбеддингов (drift/аномалии).

### 4.3. Типовые правила

Soft trigger задают через пороги и длительность:

* `Recall@K` упал на > 1% относительно baseline **и держится 7 дней**,
* `nDCG@K` упал значимо (bootstrap CI не пересекает 0),
* CTR на head‑запросах -0.5% в течение недели.

Важно:

* смотреть **по сегментам**,
* проверять, что это не инфраструктурный баг.

### 4.4. Бизнес‑примеры

**RAG.**
Доля «не найдено» выросла с 3% до 6% на конкретной теме (например, “кредиты для ИП”). Это soft trigger: можно сначала проверить обновление базы знаний, и только если не помогло — retrain.

**Рекомендации видео.**
Общее качество норм, но tail‑аудитория стала хуже кликать. Это мягкий сигнал, часто лечится дообучением на свежих interactions.

---

## 5. Как поставить retrain cadence на рельсы

### 5.1. Комбинированная схема

1. **Плановый retrain** раз в T (cadence).
2. **Hard triggers** запускают внеплановый retrain сразу.
3. **Soft triggers** запускают retrain после подтверждения.

### 5.2. Реализация мониторинга

Минимум, что нужно логировать и считать:

* потоковые распределения ключевых фич/эмбеддингов,
* quality‑метрики по контрольному набору,
* бизнес‑метрики по ключевым сегментам.

Дальше:

* алерты на hard‑порог,
* алерты на soft‑порог + “таймер выдержки” (например, 7 дней).

### 5.3. Release‑процесс

Любой retrain должен проходить те же guardrails, что и обычный релиз:

* оффлайн регресс‑пакет,
* shadow‑serve,
* canary,
* alias‑switch.

Иначе retrain превращается в «рандомные перекаты».
