# Метрики и интерпретация эффекта

> **Идея:** цель A/B‑теста не в том, чтобы «получить значимый p‑value», а в том, чтобы **оценить эффект** и понять, имеет ли он **практический (бизнес‑)смысл**.
>
> Ключевые элементы:
>
> - **Absolute uplift** — разница метрик.
> - **Relative uplift** — относительное изменение (рост/падение в процентах).
> - **Доверительные интервалы** — диапазон правдоподобных значений эффекта.
> - **Статистическая значимость vs бизнес‑ценность** — p‑value не равно польза.

---

## 1. Что такое «эффект» в A/B‑тесте

Пусть измеряется некоторая метрика \(M\) (конверсия, средний чек, CTR, LTV и т.п.).

- В контроле (A) — истинное среднее \(\mu_A\), оценка \(\hat\mu_A\).
- В тесте (B) — истинное среднее \(\mu_B\), оценка \(\hat\mu_B\).

**Эффект (effect size)**:

- В аддитивной форме: \(\Delta = \mu_B - \mu_A\).
- В относительной форме: \(\Delta_{rel} = \frac{\mu_B - \mu_A}{\mu_A}\).

На практике интересует не только факт «\(\mu_B\) отличается от \(\mu_A\)», но и:

1. Насколько **большой** эффект (в абсолютных/относительных единицах).
2. Насколько мы **уверены** в оценке (доверительные интервалы).
3. Насколько он **важен для бизнеса** (деньги, риск, побочные метрики).

---

## 2. Absolute vs Relative uplift

### 2.1. Определения

Пусть метрика — конверсия (CR), \(p_A\) в контроле и \(p_B\) в тесте.

- **Абсолютный uplift**:

  $$
  \Delta_{abs} = p_B - p_A.
  $$

  Измеряется в **процентных пунктах** (п.п.), если CR выражен в процентах.

- **Относительный uplift**:

  $$
  \Delta_{rel} = \frac{p_B - p_A}{p_A} = \frac{\Delta_{abs}}{p_A}.
  $$

  Часто выражается в процентах: \(\Delta_{rel} \cdot 100\%\).

Связь:

$$
 p_B = p_A (1 + \Delta_{rel}) = p_A + \Delta_{abs}.
$$

Для средней выручки, LTV и других непрерывных метрик формулы аналогичны.

### 2.2. Примеры

1. **CR**: \(p_A = 0.10\), \(p_B = 0.12\)

   - \(\Delta_{abs} = 0.02 = 2\) п.п.
   - \(\Delta_{rel} = 0.02 / 0.10 = 0.20 = 20\%\) относительный рост.

2. **Средний чек**: \(\mu_A = 1000\), \(\mu_B = 1050\)

   - \(\Delta_{abs} = 50\) рублей.
   - \(\Delta_{rel} = 50 / 1000 = 5\%\).

### 2.3. Когда какой uplift использовать

- **Absolute uplift**:

  - лучше отражает **масштаб эффекта** в натуральных единицах;
  - полезен при сравнениях с MDE и при пересчёте в деньги.

- **Relative uplift**:

  - удобен для отчётности («рост на 7%»);
  - позволяет сравнивать эффекты на разных продуктах/сегментах.

Практика:

- В технических отчётах всегда показывать **оба**: абсолютный и относительный uplift.
- Не интерпретировать относительный uplift без контекста **базового уровня** (baseline).

### 2.4. Подводные камни

1. **Малые базовые значения** (\(p_A\) очень мало):

   - абсолютный эффект микроскопический (\(+0.1\) п.п.),
   - относительный uplift может быть огромным («+50%»),
   - в деньгах эффект может быть несущественным.

2. **Сравнение разных экспериментов**:

   - эффект +5 п.п. при \(p_A = 5\%\) и при \(p_A = 50\%\) — это разный относительный uplift и разный бизнес‑эффект;
   - желательно приводить **полный набор**: baseline, \(\Delta_{abs}\), \(\Delta_{rel}\), пересчёт в деньги.

---

## 3. Доверительные интервалы для эффекта

### 3.1. CI для разности метрик

Пусть есть оценка эффекта \(\hat\Delta = \hat\mu_B - \hat\mu_A\) и её стандартная ошибка \(\widehat{SE}(\hat\Delta)\).

\*\*Доверительный интервал для **\(\Delta\)** уровня \*\***\(1-\alpha\)** (асимптотически нормальный):

$$
 CI_{1-\alpha}: \quad \hat\Delta \pm z_{1-\alpha/2}\, \widehat{SE}(\hat\Delta),
$$

где \(z_{1-\alpha/2}\) — квантиль стандартного нормального распределения (или t‑распределения при малых \(n\)).

Примеры:

- Для **разности долей** (CR/CTR) — стандартный Wald‑интервал или более устойчивые (Wilson, Newcombe и т.п.).
- Для **разности средних** — интервалы на основе t‑теста (Student/Welch).

Важно: доверительный интервал **строится для эффекта** (\(\Delta\)), а не только для \(\mu_A\) и \(\mu_B\) по отдельности.

### 3.2. CI для относительного uplift

Есть два варианта:

1. Строить CI непосредственно для \(\Delta_{rel}\) через дельта‑метод или лог‑трансформацию.
2. Строить CI для \(\mu_A\) и \(\mu_B\), затем превращать в диапазон для \(\Delta_{rel}\) (менее аккуратно).

Типичная практическая схема:

- Для долей используется лог‑шкала:
  $$
  \log\frac{p_B}{p_A} \Rightarrow CI, \quad \text{а затем экспонента и перевод в проценты}.
  $$

### 3.3. Интерпретация доверительного интервала

Корректная частотная интерпретация:

> Если бы мы многократно повторяли эксперимент и каждый раз строили CI тем же методом, то в \(1-\alpha\) доле случаев интервал накрыл бы истинный эффект \(\Delta\).

Для конкретного эксперимента:

- Интервал даёт **диапазон правдоподобных значений** эффекта, согласующихся с данными и моделью.
- Если CI **полностью выше 0** (например, \([+0.4; +1.2]\) п.п.) → эффект положительный и статистически значимый на уровне \(\alpha\).
- Если CI содержит 0 (например, \([-0.2; +0.8]\) п.п.) → данных недостаточно, чтобы отвергнуть H₀.

### 3.4. CI как инструмент бизнес‑интерпретации

CI полезен не только для «значимо/не значимо», но и для оценки **лучшего и худшего сценария**:

- Нижняя граница CI ≈ «консервативная оценка» эффекта;
- Верхняя граница CI ≈ «оптимистичный сценарий».

В отчётах имеет смысл явно писать:

> Оценка uplift: +0.8 п.п. (95% CI: +0.2…+1.4 п.п.).

И затем переводить обе границы в деньги/бизнес‑метрики.

---

## 4. Значимость vs бизнес‑ценность

### 4.1. Статистическая значимость

Стандартный вывод по p‑value и CI:

- **Статистически значимо** (при уровне \(\alpha\)), если p‑value \(< \alpha\) или CI не содержит 0.
- Это значит: «такие данные были бы маловероятны при отсутствии эффекта (\(\Delta = 0\))».

Но **значимость не говорит**, что эффект:

- большой,
- важный для бизнеса,
- будет сохраняться во времени.

### 4.2. Примеры перекоса

1. **Огромная выборка, микро‑эффект**:

   - Трафика много, \(n\) огромное.
   - Эффект: \(+0.05\) п.п. CR, p‑value \(< 10^{-6}\).
   - Формально «очень значимо», но в деньгах это может не окупать стоимость разработки/поддержки.

2. **Маленькая выборка, большой эффект, но незначимо**:

   - Небольшой сегмент или ранний этап продукта.
   - Эффект: +5 п.п. CR, но интервал \([-2; +12]\) п.п., p‑value \(> 0.05\).
   - Статистически уверенности нет, но **сигнал** может быть достаточно сильным, чтобы повторить тест или запустить как эксперимент для узкого сегмента с контролем рисков.

### 4.3. Бизнес‑ценность (practical significance)

Оценивается через:

- Пересчёт uplift в **деньги**:
  - дополнительная выручка/прибыль,
  - изменение юнит‑экономики.
- Влияние на **побочные метрики** (retention, churn, NPS, нагрузка на поддержку и т.п.).
- **Риски**:
  - насколько эффект нестабилен (широкий CI),
  - есть ли асимметрия риска (возможность серьёзного ухудшения).

Пример формулировки:

> Эффект: +0.7 п.п. CR (95% CI: +0.1…+1.3 п.п.), что даёт +X млн ₽ выручки в год при текущем трафике. Побочные метрики не ухудшились. Эффект статистически и практически значим.

### 4.4. Связь с MDE

**MDE** (Minimum Detectable Effect) — минимальный эффект, который тест способен обнаружить при заданных \(\alpha\), мощности и размере выборки.

- Если оцененный \(\Delta\) существенно **меньше MDE**, то даже при «значимости» эффект, скорее всего, **не представляет большого практического интереса**.
- На этапе планирования MDE должен быть завязан на **бизнес‑требования** (минимальный эффект, который ещё имеет смысл).

---

## 5. Практическая отчётность: что показывать

В отчёте по A/B‑тесту по метрикам эффекта разумно фиксировать:

1. **Базовый уровень**:

   - \(\hat\mu_A\) (baseline) с интервалом или хотя бы точной оценкой.

2. **Оценка эффекта**:

   - \(\hat\Delta_{abs}\) (абсолютный uplift),
   - \(\hat\Delta_{rel}\) (относительный uplift, в %).

3. **Надёжность оценки**:

   - 95% CI для \(\Delta_{abs}\) (и, по возможности, для \(\Delta_{rel}\)),
   - p‑value теста.

4. **Бизнес‑интерпретацию**:

   - пересчёт uplift в деньги/ключевые бизнес‑метрики,
   - при необходимости — в разрезе сегментов.

5. **Контекст**:

   - длительность теста, охваченный трафик,
   - наличие/отсутствие деградаций по другим метрикам.

Формат «одной строки» для основной метрики может выглядеть так:

> CR: 10.0% → 10.8%\
> Absolute uplift: +0.8 п.п. (95% CI: +0.2…+1.4 п.п.)\
> Relative uplift: +8% (95% CI: +2…+14%)\
> p‑value = 0.01, эффект оценочно даёт +X млн ₽ в год.

---

## 6. Пример 

Простейший пример вычисления абсолютного/относительного uplift и грубого нормального CI для разности двух долей:

```python
import numpy as np
from math import sqrt
from scipy.stats import norm

# Данные A/B (число успехов и размер групп)
x_A, n_A = 1000, 10000  # 10.0%
x_B, n_B = 1080, 10000  # 10.8%

p_A = x_A / n_A
p_B = x_B / n_B

# Uplift
delta_abs = p_B - p_A
delta_rel = delta_abs / p_A

# Стандартная ошибка (Wald-приближение)
se = sqrt(p_A * (1 - p_A) / n_A + p_B * (1 - p_B) / n_B)

alpha = 0.05
z = norm.ppf(1 - alpha / 2)
ci_low = delta_abs - z * se
ci_high = delta_abs + z * se

print(f"Baseline p_A = {p_A:.4f}")
print(f"p_B          = {p_B:.4f}")
print(f"Absolute uplift = {delta_abs:.4f}")
print(f"Relative uplift = {delta_rel*100:.1f}%")
print(f"95% CI for Δ_abs: [{ci_low:.4f}, {ci_high:.4f}]")
```

В реальных системах вместо простого Wald‑CI для долей часто используют более устойчивые варианты (Wilson/Newcombe), но структура интерпретации остаётся той же: baseline → эффект → CI → бизнес‑смысл.

