# Sequential-тесты и CUPED

> **Идея:** классический A/B-тест предполагает фиксированную длительность и простую разницу средних. Sequential-тесты позволяют **останавливать эксперимент раньше** без раздувания ошибки первого рода, а CUPED уменьшает **дисперсию оценки эффекта**, сохраняя его несмещённость.  
> **Цель:** сократить время теста и/или размер выборки **без нарушения корректности** (уровня $\alpha$ и честной p-value).

## 1. Проблема «подглядывания» и фиксированный горизонт

### 1.1. Фиксированный горизонт в классическом тесте

Стандартный A/B-тест обычно проектируется так:

* заранее задаём:

  * уровень значимости $\alpha$,
  * мощность $1 - \beta$,
  * MDE,
  * **фиксированный размер выборки** $n$;
* копим данные до $n$ и **ровно один раз** считаем тест (p-value, CI и т.п.).

При таком подходе гарантии по $\alpha$ и мощности верны.

### 1.2. Наивное «подглядывание» (peeking)

Типичное «как делают в проде»:

* тест запущен на 2 недели,
* но каждые день-два смотрят на p-value,
* как только p-value «упал ниже 0.05» – тест останавливают и объявляют победителя.

Проблема:

* каждая новая «проверка» увеличивает шанс случайно поймать **ложно значимый результат**;
* реальная ошибка первого рода становится **существенно больше $\alpha$**.

Итого: наивное последовательное наблюдение p-value **ломает** частотные гарантии.

Sequential-тесты решают это математическим способом, а не «на интуиции».

---

## 2. Sequential-тесты: идея и виды

### 2.1. Базовая идея sequential-теста

Вместо одного фиксированного момента анализа мы заранее конструируем **правило остановки**, которое:

* разрешает смотреть на данные **многократно** (последовательно),
* при этом **гарантирует**, что ошибка первого рода не превышает заданный уровень $\alpha$.

Sequential-тест задаёт:

* когда мы можем смотреть на данные (анализ «по шагам» или в любой момент),
* какие **границы остановки** используем:

  * «остановиться и принять $H_1$» (эффект есть),
  * «остановиться и принять $H_0$» (эффекта нет),
  * «продолжать собирать данные».

### 2.2. Group-sequential тесты

**Group-sequential**: анализ делается **пакетами** (группами наблюдений), а не после каждого нового события.

Пример схемы:

* планируем до 4 промежуточных анализов на:

  * 25%, 50%, 75% и 100% от целевого размера выборки;
* на каждом анализе считаем статистику и сравниваем её с заранее заданными порогами.

Типичные подходы к выбору границ:

* **Pocock**:

  * примерно одинаковый порог значимости на каждом анализе.
* **O'Brien–Fleming**:

  * очень строгие пороги в начале (сложно остановить тест рано),
  * более мягкие пороги ближе к концу.

Смысл: распределить общий бюджет $\alpha$ между несколькими «взглядами» на данные (**alpha-spending**).

### 2.3. Always-valid / sequential p-values (интуитивно)

Более продвинутый подход:

* определяют **последовательную статистику** и p-value, которые корректны **в любой момент времени**, при любом количестве «подглядываний»;
* формулируется через мартингальные тесты, mixture-тесты и т.п.

Интуитивно:

* p-value устроен так, что при истинной $H_0$ вероятность **когда-либо** увидеть «слишком маленькое» p-value (например, $< \alpha$) не превышает $\alpha$.

Практический эффект:

* можно мониторить тест онлайн,
* останавливаться в удобный момент,
* и при этом сохранять честный уровень $\alpha$.

### 2.4. Что дают sequential-тесты

Плюсы:

* можно **закончить тест раньше**, если эффект явно есть (или явно отсутствует);
* более гибкое управление риском: останавливаемся при первых уверенных сигналах;
* нет жёсткой привязки к одному «дню X» анализа.

Минусы:

* сложнее реализовать и объяснить продактам,
* нужно заранее зафиксировать протокол: моменты анализов, границы, правила остановки,
* типовые онлайн-калькуляторы A/B-тестов обычно не учитывают sequential-дизайны.

---

## 3. CUPED: снижение дисперсии с помощью ковариат

### 3.1. Интуиция CUPED

**CUPED (Controlled experiments Using Pre-Experiment Data)** – метод снижения дисперсии оценок эффекта за счёт использования **дополнительных признаков (covariates)**, обычно измеренных **до эксперимента**.

Обозначения:

* $Y$ – целевая метрика эксперимента (после старта теста),
* $X$ – ковариата, связанная с $Y$ и измеренная **до** применения treatment
  (например, прошлый чек, прошлый CR, активность пользователя до эксперимента).

Идея:

* если $X$ сильно коррелирует с $Y$, то разница в $X$ между пользователями объясняет часть разброса $Y$;
* если «вычесть» влияние $X$, то остаётся менее шумная метрика → дисперсия меньше → тест мощнее.

### 3.2. Формула CUPED-коррекции

Строим новую метрику:

$$
Y^{(adj)} = Y - \theta (X - \bar X),
$$

где:

* $\bar X$ – среднее $X$ по всем пользователям (A+B вместе),
* $\theta$ обычно берут как

$$
\theta^* = \frac{\operatorname{Cov}(Y, X)}{\operatorname{Var}(X)}.
$$

Свойства:

* оценка эффекта по $Y^{(adj)}$ остаётся **несмещённой**,
* дисперсия уменьшается примерно по формуле

$$
\operatorname{Var}(Y^{(adj)}) \approx \operatorname{Var}(Y)\cdot(1 - \rho^2),
$$

где $\rho$ – корреляция между $X$ и $Y$.

Если $|\rho|$ большой, выигрыш по дисперсии может быть очень заметным.

### 3.3. Применение CUPED на практике

Типичный пайплайн:

1. Выбираем ковариату $X$:

   * доступна до эксперимента (pre-period),
   * сильно коррелирует с целевой метрикой $Y$,
   * логически не зависит от treatment (на неё нельзя повлиять новой фичой).
2. Оцениваем $\theta^*$:

   * на pre-period-данных или на отдельной выборке.
3. Для каждого пользователя считаем $Y^{(adj)}$.
4. В A/B-тесте сравниваем **средние $Y^{(adj)}$** между группами, а не исходный $Y$.

Результат:

* та же схема статистического теста (z, t, бутстрап и пр.),
* но при том же N – выше мощность,
* или при той же мощности – можно уменьшить N (и/или длительность теста).

### 3.4. Ограничения и подводные камни CUPED

Нужно следить за:

* корректностью ковариаты:

  * она должна быть из периода **до** воздействия,
  * treatment не должен менять $X$;
* стабильностью измерения $X$;
* честной оценкой $\theta$ (желательно на данных, независимых от основной оценки эффекта).

Типичные фейлы:

* использовать $X$, на которую уже повлиял treatment → смещённый эффект;
* «подгонять» $\theta$ на тех же данных, где оценивать эффект, и радоваться слишком красивым p-value.

---

## 4. Как sequential-тесты и CUPED помогают сокращать тест

### 4.1. Sequential-подход

Sequential-тесты уменьшают **ожидаемую** длительность:

* при большом эффекте тест часто останавливается **раньше**, чем фиксированный,
* при нулевом/очень малом эффекте доходим до максимального N.

Честно спроектированный sequential-тест при этом:

* сохраняет заданный уровень $\alpha$,
* обеспечивает нужную мощность.

### 4.2. CUPED

CUPED уменьшает **дисперсию** метрики:

* при фиксированном N → растёт мощность (легче поймать эффект),
* при заданной мощности → можно уменьшить N (или срок эксперимента).

Если $|\rho|$ велик, CUPED может давать эквивалент увеличения «эффективного» размера выборки в разы.

### 4.3. Комбинация

Sequential и CUPED **совместимы**:

* в sequential-дизайне можно использовать CUPED-скорректированную метрику $Y^{(adj)}$ как основную;
* тогда каждый промежуточный анализ опирается на менее шумную метрику, и границы достигаются быстрее при тех же $\alpha$ и мощности.

Критично: протокол (границы, моменты анализа, правило остановки) должен быть зафиксирован **до** старта, а не подстраиваться под наблюдаемые кривые.

---

## 5. Что фиксировать в конспекте / отчёте

Для **sequential-тестов**:

* тип подхода:

  * group-sequential (фиксированные «срезы»),
  * или always-valid / online-мониторинг;
* общий уровень $\alpha$ и схема его «трат» (alpha-spending);
* число и моменты промежуточных анализов;
* правила остановки:

  * при каких условиях принимаем $H_1$,
  * при каких – $H_0$,
  * когда продолжаем тест.

Для **CUPED**:

* что выбрано в роли ковариаты $X$ и почему;
* на каких данных оценён $\theta^*$;
* оценка $\rho(X, Y)$ и примерный ожидаемый выигрыш по дисперсии;
* проверки, что treatment не влияет на $X$.

Общее:

* как за счёт sequential-подхода и CUPED меняются:

  * ожидаемая длительность теста,
  * минимальный обнаружимый эффект (MDE),
  * требуемый размер выборки;
* отдельной строкой – что корректность по $\alpha$ и несмещённость сохранены за счёт специальной конструкции методов, а не «подглядывания с молчаливой надеждой».
