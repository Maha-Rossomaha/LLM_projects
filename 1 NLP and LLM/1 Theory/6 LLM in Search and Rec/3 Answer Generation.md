# Генерация ответа по результатам Retrieval и Reranking

## 1. Мотивация

После этапов retrieval и reranking мы получаем список наиболее релевантных документов. Следующий шаг — сформировать финальный ответ пользователю или другой системе (например, в RAG-пайплайне для LLM). Этот этап критически важен для:

- Повышения точности и полноты ответа.
- Снижения галлюцинаций при использовании LLM.
- Презентации информации в удобном и понятном формате.

---

## 2. Общий пайплайн

1. **Retrieval** — быстрый отбор кандидатов из корпуса.
2. **Reranking** — перестановка кандидатов по качеству.
3. **Answer Generation** — формирование итогового ответа.

---

## 3. Подходы к генерации ответа

### 3.1 Extractive Answer Generation

- Модель выбирает релевантный фрагмент из документа.
- Часто используется в QA-системах (SQuAD-style).
- Преимущество: высокая точность и контроль над источником.
- Недостаток: низкая гибкость в формулировке.

### 3.2 Abstractive Answer Generation

- Модель формулирует ответ своими словами, интегрируя информацию из нескольких документов.
- Используются seq2seq или decoder-only LLM (T5, GPT).
- Преимущество: возможность обобщения и переформулировки.
- Недостаток: риск галлюцинаций.

### 3.3 Hybrid

- Сначала извлечение релевантных фрагментов, затем их переформулировка.
- Комбинирует контроль над источниками и гибкость формулировки.

---

## 4. Методы отбора контекста

- **Top-K Selection**: выбор N документов с наибольшим скором.
- **Marginal Utility Filtering**: удаление документов, добавление которых не увеличивает полезность ответа.
- **Clustering & Diversity**: выбор документов из разных кластеров для покрытия тематики.
- **Sliding Window / Chunking**: разбиение длинных документов на части.

---

## 5. Техники генерации с LLM

- **Prompt Engineering**: чёткое указание модели на использование данных из контекста.
- **Citation / Provenance**: указание источников в ответе.
- **Chain-of-Thought**: пошаговое рассуждение перед генерацией.
- **Reroll при низкой уверенности**: повторная генерация, если уверенность в ответе низкая.

---

## 6. Метрики качества

- **Groundedness**: доля утверждений, подтверждённых контекстом.
- **Faithfulness**: отсутствие противоречий источникам.
- **Answer Relevance**: соответствие ответа запросу.
- **ROUGE / BLEU / METEOR** для сравнения с эталонными ответами.

---

## 7. Оптимизация

- **Context Length Management**: отбор наиболее информативных фрагментов.
- **Few-shot примеры**: добавление образцов в prompt для улучшения качества.
- **Post-processing**: исправление форматирования, удаление лишнего.

---

## 8. Риски и вызовы

- Галлюцинации модели.
- Потеря важной информации при агрессивной фильтрации контекста.
- Увеличение задержки при большом контексте.
