# Retrieval Reranking

## 1. Мотивация

Reranking — это этап после первичного поиска (retrieval), на котором отобранные кандидаты (обычно top-K документов) переставляются в порядке большей релевантности. Основная цель — повысить качество финальной выдачи без значительного увеличения времени отклика.

**Почему это важно:**

- Первичный поиск часто использует быстрые, но приближённые методы (BM25, dense ANN), которые могут ошибаться.
- Reranker учитывает более сложные признаки и взаимодействия, улучшая итоговый порядок.

---

## 2. Пайплайн Retrieval → Reranking

1. **Retrieval**: быстрый отбор кандидатов (sparse, dense или hybrid).
2. **Reranking**: пересчёт релевантности с использованием более мощной модели.
3. **Output**: финальный список N лучших документов для пользователя или LLM.

---

## 3. Виды Reranker-моделей

### 3.1 Bi-Encoder (Light Reranking)

- Кодирует запрос и документ независимо.
- Быстро работает, но хуже учитывает контекстное взаимодействие.
- Пример: SBERT, E5.

### 3.2 Cross-Encoder (Full Interaction)

- Совместно кодирует запрос и документ.
- Учитывает полное взаимодействие токенов, даёт лучшую точность.
- Пример: monoT5, BGE-reranker.
- Недостаток: высокая вычислительная стоимость.

### 3.3 Late Interaction (ColBERT)

- Кодирует токены отдельно, но взаимодействие считается на уровне токеновых векторов (MaxSim).
- Баланс между качеством и скоростью.
- Пример: ColBERT, ColBERTv2.

---

## 4. Multi-Stage Reranking

Часто используется каскад:

1. **Первичный retrieval**: fast sparse/dense поиск (K \~ 1k–10k).
2. **Stage 1**: лёгкий reranker (bi-encoder / late interaction) → сокращение до M кандидатов.
3. **Stage 2**: тяжёлый cross-encoder → выбор финальных N документов.

**Преимущества каскада:**

- Оптимизация latency.
- Сохранение качества за счёт применения тяжёлых моделей только на небольшой выборке.

---

## 5. Признаки для Reranking

- Релевантность по dense и sparse поиску.
- Позиция в первоначальном списке.
- Свежесть документа.
- Пользовательские сигналы (CTR, dwell-time).

---

## 6. Метрики качества

- **MRR (Mean Reciprocal Rank)**
- **nDCG\@K (Normalized Discounted Cumulative Gain)**
- **Recall\@K**
- Онлайн: CTR, dwell-time, conversion rate.

---

## 7. Оптимизация Reranking

- **Batching**: обработка сразу нескольких пар запрос-документ.
- **Distillation**: перенос знаний с cross-encoder на bi-encoder.
- **Quantization**: INT8/FP16 для ускорения.
- **Pruning**: уменьшение длины входа и числа токенов.

---

## 8. Инфраструктура

- **Модели**: HuggingFace Transformers, OpenAI API (rerank endpoints), Cohere Rerank.
- **Сервисы**: Triton Inference Server, vLLM, FastAPI + GPU inference.
- **Оркестрация**: Airflow / Prefect для A/B тестов и переобучения.

---

## 9. Риски и вызовы

- Высокая стоимость при больших K.
- Деградация качества при embedding drift.
- Баланс между скоростью и качеством.
