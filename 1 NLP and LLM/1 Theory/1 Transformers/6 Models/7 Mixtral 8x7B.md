# –ö–æ–Ω—Å–ø–µ–∫—Ç Mixtral¬†8√ó7B (Sparse Mixture‚Äëof‚ÄëExperts)

URL:  
üîó [Mixtral 8x7B](https://mistral.ai/news/mixtral-of-experts)

## 1. –û–±—â–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞

- **Mixtral¬†8√ó7B**¬†‚Äî —è–∑—ã–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å —Å —Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω–æ–π —Å–º–µ—Å—å—é —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ (Sparse¬†MoE), –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–≤–µ—Ä—Ö Mistral‚ÄØ7B.
- –Ø–¥—Ä–æ –∏–¥–µ–∏: —É–≤–µ–ª–∏—á–∏—Ç—å *—Å—É–º–º–∞—Ä–Ω–æ–µ* –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (‚âà‚ÄØ47‚ÄØB) –±–µ–∑ —Ä–æ—Å—Ç–∞ *–∞–∫—Ç–∏–≤–Ω—ã—Ö* –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–∏ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–µ (‚âà‚ÄØ13‚ÄØB) –∑–∞ —Å—á—ë—Ç —É—Å–ª–æ–≤–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç $32\,768$ —Ç–æ–∫–µ–Ω–æ–≤, —Ä–æ—É—Ç–µ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç $K=2$ —ç–∫—Å–ø–µ—Ä—Ç–∞ –∏–∑ $N=8$ –Ω–∞¬†–∫–∞–∂–¥–æ–º —Å–ª–æ–µ –∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞.
- –ö–∞–∂–¥—ã–π —ç–∫—Å–ø–µ—Ä—Ç¬†‚Äî FFN‚Äë–±–ª–æ–∫ —Å–æ SwiGLU –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π; –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ (GQA, SWA) —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω—ã –æ—Ç¬†Mistral‚ÄØ7B.

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥–µ–ª–∏

### 2.1 –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –°–ª–æ–∏ (decoder)      | $32$ |
| –ú–æ–¥–µ–ª—å–Ω–∞—è —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å $d$ | $4096$ |
| Heads / KV‚ÄëHeads    | $32 / 8$ |
| Hidden¬†FFN dim      | $14\,336$ |
| –≠–∫—Å–ø–µ—Ä—Ç–æ–≤ –≤¬†—Å–ª–æ–µ $N$| $8$ |
| –ê–∫—Ç–∏–≤–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ $K$ | $2$ |
| –ö–æ–Ω—Ç–µ–∫—Å—Ç            | $32\,k$ |
| –°–ª–æ–≤–∞—Ä—å             | $32\,k$ |

### 2.2 Mixture‚Äëof‚ÄëExperts (MoE) —Å–ª–æ–π

**–í—ã—Ö–æ–¥** –ú–æE –¥–ª—è –≤—Ö–æ–¥–Ω–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–∞ $x$ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤–∑–≤–µ—à–µ–Ω–Ω–æ–π —Å—É–º–º–æ–π –æ—Ç–∫–ª–∏–∫–æ–≤ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤:

$$y = \sum_{i=0}^{N-1} G(x)_i\;E_i(x).$$

–ó–¥–µ—Å—å $E_i$¬†‚Äî $i$‚Äë–π —ç–∫—Å–ø–µ—Ä—Ç (SwiGLU¬†FFN), –∞ $G(x)$¬†‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã–π –≤–µ–∫—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–∞.

#### –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä (Router)

–°–Ω–∞—á–∞–ª–∞ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è *–ª–æ–≥–∏—Ç—ã* –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ $s = x W_g\in\mathbb R^{N}$. –ó–∞—Ç–µ–º –±–µ—Ä—ë—Ç—Å—è –æ–ø–µ—Ä–∞—Ü–∏—è $\text{TopK}$, ¬´–æ–±–Ω—É–ª—è—é—â–∞—è¬ª –≤—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –∫—Ä–æ–º–µ $K$¬†–∫—Ä—É–ø–Ω–µ–π—à–∏—Ö:

$$\text{TopK}(s)_i = \begin{cases} s_i, & s_i \in \text{top-}K(s)\\ -\infty, & \text{–∏–Ω–∞—á–µ}\end{cases}.$$

–ü–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è softmax:

$$G(x) = \mathrm{Softmax}(\text{TopK}(xW_g)).$$

–¢–æ–ª—å–∫–æ $K$ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –ø–æ–ª—É—á–∞—é—Ç –Ω–µ–Ω—É–ª–µ–≤—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∏ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è.

#### –≠–∫—Å–ø–µ—Ä—Ç (SwiGLU‚ÄëFFN)

–ö–∞–∂–¥—ã–π —ç–∫—Å–ø–µ—Ä—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ

$$E_i(x) = W_{2,i}\,\mathrm{SiLU}\bigl(xW_{1,i}\bigr) \odot xW_{3,i},$$

–≥–¥–µ $\odot$¬†‚Äî –ø–æ—ç–ª–µ–º–µ–Ω—Ç–Ω–æ–µ —É–º–Ω–æ–∂–µ–Ω–∏–µ; SwiGLU —Å–Ω–∏–∂–∞–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –æ–±—ã—á–Ω—ã–º GELU‚ÄëFFN.

### 2.3 –ê–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø–æ–ª–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

–û–±—â–µ–µ —á–∏—Å–ª–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ FFN —Å–ª–æ—è:
$$P_{\text{total}} = N\,P_{\text{FFN}},$$
–Ω–æ –≤¬†–æ–¥–Ω–æ–º —à–∞–≥–µ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏—à—å
$$P_{\text{active}} = K\,P_{\text{FFN}}.$$

–ü—Ä–∏ $N=8$, $K=2$ —ç–∫–æ–Ω–æ–º–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç $4\times$.

### 2.4 –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏

–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä –æ–±—É—á–∞–µ—Ç—Å—è —Å¬†–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º *load‚Äëbalancing* —à—Ç—Ä–∞—Ñ–æ–º, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞—é—â–∏–º –¥–æ–ª—é —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞:

$$L_{\text{balance}} = \lambda \sum_{i=0}^{N-1} \left( \frac{n_i}{\sum_j n_j} - \frac{1}{N} \right)^2,$$

–≥–¥–µ $n_i$¬†‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–º –≤—ã–±—Ä–∞–Ω —ç–∫—Å–ø–µ—Ä—Ç $i$ –≤¬†–±–∞—Ç—á–µ.

### 2.5 –í—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å

- **–í—Ä–µ–º—è** –Ω–∞ FFN‚Äë—á–∞—Å—Ç—å —Å–ª–æ—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç $K$, –∞¬†–Ω–µ –æ—Ç $N$: $O(Kd^2)$ vs. $O(Nd^2)$ –ø—Ä–∏ –ø–ª–æ—Ç–Ω–æ–º FFN.
- **–ü–∞–º—è—Ç—å** KV‚Äë–∫–µ—à–∞ —Ç–∞–∫–∞—è –∂–µ, –∫–∞–∫ —É¬†Mistral¬†7B, –ø–æ—Å–∫–æ–ª—å–∫—É MoE –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ FFN.
- **–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è**: –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–∂–¥—É GPU –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è *Expert Parallelism*; —Ç–æ–∫–µ–Ω—ã —Ä–æ—É—Ç—è—Ç—Å—è –∫¬†–Ω—É–∂–Ω—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º –ø–æ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä—É Megablocks.

## 3. –û–±—É—á–µ–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- **–î–∞–Ω–Ω—ã–µ**: –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–π –∫–æ—Ä–ø—É—Å –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤; –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏—Ö —è–∑—ã–∫–æ–≤ –ø–æ–≤—ã—à–µ–Ω—ã –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å¬†Mistral¬†7B.
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç**: —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å—Ä–∞–∑—É –Ω–∞ $32\,k$ —Ç–æ–∫–µ–Ω–∞—Ö, –±–µ–∑ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–µ—Å–∫–µ–π–ª–∞.
- **–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä**: AdamW —Å¬†–∫–æ–≤–∞—Ä–∏–∞–Ω—Ç–Ω—ã–º –∫–ª–∏–ø–ø–∏–Ω–≥–æ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞; –∫–æ—Å–∏–Ω—É—Å–Ω—ã–π warm‚Äëup –¥–æ –ø–∏–∫–∞ LR, –∑–∞—Ç–µ–º decay.
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: —Ä–∞–Ω–Ω—è—è —Ñ–∞–∑–æ–≤–∞—è –ø—Ä–æ–≥—Ä–µ–≤–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞, gradient clipping –Ω–∞ —É—Ä–æ–≤–Ω–µ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤, —Å–º–µ—à–∞–Ω–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å bfloat16 + FP8.
- **–†–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è**: $L_{\text{balance}}$ –∏¬†–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω‚Äë–¥—Ä–æ–ø‚Äë–∞—É—Ç, –≤—ã–∫–ª—é—á–∞—é—â–∏–π –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–∫—Å–ø–µ—Ä—Ç—ã –¥–ª—è¬†—Ä–æ–±–∞—Å—Ç–Ω–æ—Å—Ç–∏.

## 4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ü–∞–º—è—Ç—å**: –≤—Å–µ 47‚ÄØB –≤–µ—Å–æ–≤ –¥–æ–ª–∂–Ω—ã –ª–µ–∂–∞—Ç—å –≤‚ÄØGPU/CPU‚Äë–ø–∞–º—è—Ç–∏, —Ö–æ—Ç—è —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞.
2. **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä** –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–∫—Å–ø–µ—Ä—Ç—ã; –Ω—É–∂–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ softmax.
3. **–ö–æ–Ω—Ç–µ–∫—Å—Ç** –æ–≥—Ä–∞–Ω–∏—á–µ–Ω 32‚ÄØk¬†‚Äî –¥–ª—è —Å–≤–µ—Ä—Ö–¥–ª–∏–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –ø—Ä–∏–≥–æ–¥—è—Ç—Å—è SWA‚Äë–ø–æ–¥–æ–±–Ω—ã–µ –æ–∫–Ω–∞.
4. **–§—É–Ω–∫—Ü–∏–∏ —Å–º–µ—à–µ–Ω–∏—è** –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, Router‚ÄëMoE —Å¬†—ç–Ω–µ—Ä–≥–æ‚Äë–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π).
5. **–≠–Ω–∫–æ–¥–µ—Ä‚Äë–¥–µ–∫–æ–¥–µ—Ä** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ MoE –≤¬†–¥–≤—É—Ö‚Äë–ø–æ—Ç–æ—á–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –æ—Å—Ç–∞—ë—Ç—Å—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–æ–π.