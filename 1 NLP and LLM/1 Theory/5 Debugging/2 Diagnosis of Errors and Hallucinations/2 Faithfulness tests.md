# Faithfulness tests

## 1. Что такое faithfulness в контексте LLM

**Faithfulness** — степень, в которой ответ модели корректно отражает информацию, содержащуюся в предоставленных данных (retrieved документы, контекст из prompt). В отличие от «правильности» (accuracy), которая оценивает фактологическую верность относительно внешнего мира, faithfulness оценивает соответствие именно данному контексту.

---

## 2. Зачем нужны faithfulness-тесты

* **Предотвращение галлюцинаций**: модель может генерировать правдоподобный, но не основанный на контексте текст.
* **Мониторинг качества RAG-пайплайнов**: проверка, что генератор опирается на retrieved документы.
* **Отладка retrieval и reranking**: помогает понять, насколько хорошо генератор использует релевантную информацию.
* **Повышение доверия**: особенно важно в системах, где критична прозрачность.

---

## 3. Основные причины нарушения faithfulness

* Недостаточный или нерелевантный retrieved контент.
* Неверная интерпретация данных моделью.
* Добавление собственных домыслов вне предоставленных источников.
* Перефразирование, искажающее исходный смысл.

---

## 4. Методы оценки faithfulness

### 4.1 Автоматическая проверка по совпадению фактов

* **Fact overlap**: извлечение фактов из ответа и контекста (NER, relation extraction) → сравнение.
* **ROUGE/BLEU/Overlap Metrics**: косвенные метрики, плохо работают при перефразировании.

### 4.2 Semantic similarity

* Сравнение эмбеддингов утверждений ответа с предложениями из контекста.
* Использование модели для оценки «поддерживается / не поддерживается» (entailment).

### 4.3 Модели оценки faithfulness

* **RAGAS**: автоматическая оценка groundedness, answer relevance.
* **QAFactEval**: генерация вопросов по ответу и поиск их ответов в контексте.
* **FactScore**: вычисляет долю утверждений, подтверждённых контекстом.

### 4.4 Human-in-the-loop

* Аннотаторы вручную отмечают, какие части ответа подтверждаются контекстом.
* Чаще всего используется для валидации автоматических метрик.

---

## 5. Пайплайн проведения тестов

1. Собрать тестовый набор запросов с контекстом и ответами.
2. Применить автоматические метрики (semantic similarity, entailment).
3. Проверить часть выборки вручную.
4. Сопоставить результаты и определить пороговые значения для автоматической фильтрации.
5. Настроить мониторинг faithfulness в продакшне.

---

## 6. Применение в продакшне

* **RAG-системы**: фильтрация или пометка ответов с низким faithfulness.
* **QA-сервисы**: автоматическая переоценка ответа, если он не поддерживается контекстом.
* **Автоматический ретригер retrieval**: при низком faithfulness перезапуск поиска документов.

---

## 7. Плюсы и минусы методов

**Плюсы:**

* Повышают надёжность и прозрачность.
* Можно интегрировать в автоматические пайплайны.
* Совместимы с human-in-the-loop.

**Минусы:**

* Автоматические метрики могут ошибаться при сложных перефразах.
* Требуют вычислительных ресурсов (особенно semantic similarity на больших данных).
* Зависимость от качества исходных эмбеддингов или NLI-моделей.

---

## 8. Рекомендации по снижению проблем с faithfulness

* Улучшить качество retrieval и reranking.
* Использовать инструкцию в prompt: «Отвечай только на основе предоставленного контекста».
* Применять вторичный LLM для валидации фактов.
* Обучать генератор на данных, где penalизируется выход за пределы контекста.
