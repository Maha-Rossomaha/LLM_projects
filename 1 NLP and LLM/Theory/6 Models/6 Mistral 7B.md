# ะะพะฝัะฟะตะบั ััะฐััะธ ยซPapersยExplainedย64:ยMistralโฏ7Bยป (DAIR.AI)

URL:  
๐ [Mistral 7B](https://medium.com/dair-ai/papers-explained-mistral-7b-b9632dedf580)

## 1. ะะปััะตะฒัะต ะฒัะฒะพะดั

- **Mistralโฏ7B**ยโ ะพัะบัััะฐั LLM ะฝะฐย7,3ยะผะปัะดโฏะฟะฐัะฐะผะตััะพะฒ, ะดะตะผะพะฝัััะธััััะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะฝะฐยััะพะฒะฝะต ะธะปะธ ะฒััะต ะผะพะดะตะปะตะน Llamaโฏ2โฏ13B ะธยLlamaโฏ1โฏ34B ะฟัะธยัััะตััะฒะตะฝะฝะพ ะผะตะฝััะธั ะฒััะธัะปะธัะตะปัะฝัั ะทะฐััะฐัะฐั.
- ะะฒะฐ ัะดัะฐ ัััะตะบัะธะฒะฝะพััะธ: **GroupedโQuery Attention (GQA)** ััะบะพััะตั ะดะตะบะพะดะธัะพะฒะฐะฝะธะต, ะฐย**SlidingโWindow Attention (SWA)** ะผะฐัััะฐะฑะธััะตั ะบะพะฝัะตะบัั, ัะพััะฐะฝัั ะปะธะฝะตะนะฝัั ัะปะพะถะฝะพััั ะธยัะบะพะฝะพะผะธั ะฟะฐะผััะธ.
- ะะฑััะตะฝะฐ ยซัยะฝัะปัยป; ะพะฟัะฑะปะธะบะพะฒะฐะฝะฐ ะฑะฐะทะพะฒะฐั ะฒะตััะธั **v0.1** (8k ะบะพะฝัะตะบัั) ะธยะฒะฐัะธะฐะฝัั **v0.2** (32k ะบะพะฝัะตะบัั, ะฑะตะทยSWA) ะธย**v0.3** (ะฟะพะดะดะตัะถะบะฐ tokenizerโฏv3, 32โฏ768ยัะพะบะตะฝะพะฒ ัะปะพะฒะฐัั, functionยcalling).
- Fineโtunedโะฒะตััะธั **Mistralโฏ7BโฏInstruct** ะปะธะดะธััะตั ััะตะดะธ ะฒัะตั 7BโLLM ะฝะฐยMTโBench ะธยะฟัะตะดะฟะพััะธัะตะปัะฝะตะต Llamaโฏ2โฏ13BยChat ะฒยัะตะปะพะฒะตัะตัะบะพะผ ััะฐะฒะฝะตะฝะธะธ.
- ะะฐัะฟัะพัััะฐะฝัะตััั ะฟะพะด ัะฒะพะฑะพะดะฝะพะน ะปะธัะตะฝะทะธะตะน **Apacheโฏ2.0**.

## 2. ะฆะตะปั ัะฐะฑะพัั

ะกะพะทะดะฐัั ะบะพะผะฟะฐะบัะฝัั ะผะพะดะตะปั, ะบะพัะพัะฐั:

1. **ะกะพะฟะตัะฝะธัะฐะตั** ัยะฑะพะปะตะต ะบััะฟะฝัะผะธ LLM ะฟะพยะบะฐัะตััะฒั.
2. **ะะตัะตะฒะปะต** ะฒยัะตัะฒะตัะฝัั ัะฐััะพะดะฐั (ะฟะฐะผััั,ยlatency).
3. **ะะธะฑะบะพ** ะดะพะพะฑััะฐะตััั ะธยะฒัััะฐะธะฒะฐะตััั ะฒยัะฐะทะปะธัะฝัะต ะฟะฐะนะฟะปะฐะนะฝั.

## 3. ะััะธัะตะบัััะฐ

Mistralโฏ7B ะฟะตัะตัะผะฐััะธะฒะฐะตั ะบะปะฐััะธัะตัะบะธะน Transformer, ััะพะฑั ัะฝััั ะดะฒะฐ ะบะปััะตะฒัั ะฑะฐััะตัะฐ ะฟัะฐะบัะธัะตัะบะพะณะพ ะฟัะธะผะตะฝะตะฝะธั LLM: ัะพัั \$O(n^2)\$ ะฒยselfโattention ะธยะปะธะฝะตะนะฝัะน ัะพัั KVโะบะตัะฐ ะฟัะธยะฐะฒัะพะดะตะบะพะดะธัะพะฒะฐะฝะธะธ. ะะพะผะฐะฝะดะฐ ะธัะฟะพะปัะทัะตั ัะตัััะต ะฒะทะฐะธะผะพะดะพะฟะพะปะฝัััะธั ัะตัะฝะธะบะธ.

### 3.1 GroupedโQuery Attention (GQA)

- **ะะดะตั.** ะััะธัะปััั ะบะปััะธ/ะทะฝะฐัะตะฝะธั (\$K,V\$) ะฝะต ะดะปั ะบะฐะถะดะพะน ะธะท \$H\_q\$ queryโะณะพะปะพะฒ, ะฐยะปะธัั ะดะปั ะผะตะฝััะตะณะพ ัะธัะปะฐ \$H\_{kv}\$ ะธยะดะตะปะธัััั ะธะผะธ ะฒะฝัััะธ ะณััะฟะฟั ะธะท \$g=H\_q / H\_{kv}\$ queries.
- **ะคะพัะผะฐ ัะตะฝะทะพัะพะฒ.** \$Q\in\mathbb R^{B\times L\times H\_q\times d}\$, \$K, V\in\mathbb R^{B\times L\times H\_{kv}\times d}\$. ะะปั Mistral: \$H\_q=32\$, \$H\_{kv}=8\$, \$g=4\$.
- **ะกะปะพะถะฝะพััั.** ะะฐะผััั ะธยะฒััะธัะปะตะฝะธั ะฝะฐ ััะฐะฟะต ยซdecodeโstepยป ัะผะตะฝััะฐัััั ะฟะพััะธ ะฒย\$g\$ยัะฐะท, ะฟะพัะบะพะปัะบั ััะฐะฝะธััั ะธยัะผะฝะพะถะฐะตััั ะผะตะฝััะต KVโะฟะฐั.
- **ะญะผะฟะธัะธะบะฐ.** ะะพยะดะฐะฝะฝัะผ ะฐะฒัะพัะพะฒ, GQA ะดะฐัั \$\approx\$4ร ัะบะพะฝะพะผะธั VRAM ะธยะดะพย1.4ร ััะบะพัะตะฝะธะต ะฟัะธยัะฐะฒะฝะพะผ ะบะฐัะตััะฒะต ะฝะฐยMTโBench.

### 3.2 SlidingโWindow Attention (SWA)

- **ะะบะฝะพย\$W\$.** ะะฐะถะดัะน ัะปะพะน ะพะฑัะฐะฑะฐััะฒะฐะตั ัะพะปัะบะพ ะฟะพัะปะตะดะฝะธะต \$W\$ ัะพะบะตะฝะพะฒ (ะฒ Mistral \$W=4096\$).
- **ะะตัะตะดะฐัะฐ ะธะฝัะพัะผะฐัะธะธ.** ะกัะตะบ ะธะท \$K\$ ัะปะพัะฒ ยซัะบะพะปัะทะธัยป ะฟะพะฒะตัั ะฒัะพะดะฐ: ัะพะบะตะฝ, ะฒัะฟะฐะฒัะธะน ะธะท ะพะบะฝะฐ ัะปะพัย\$\ell\$, ะฒัั ะตัั ะผะพะถะตั ะฒะทะฐะธะผะพะดะตะนััะฒะพะฒะฐัั ัยัะตะบััะธะผะธ ัะพะบะตะฝะฐะผะธ ัะตัะตะท ัะปะพะนย\$\ell+1\$. ะขะตะผ ัะฐะผัะผ ัััะตะบัะธะฒะฝะพะต ยซะฟะพะบัััะธะตยป ัะฐะฒะฝะพ \$W\cdot K\$ ะฑะตะท ะบะฒะฐะดัะฐัะธัะฝัั ะทะฐััะฐั.
- **ะัะฐะบัะธะบะฐ.** ะะพะฝัะตะบัั ัะฒััะต 128ยk ะดะพััะธะณะฐะตััั ะฟัะธย16ยk ัะพะบะตะฝะฐั ัะฐะบัะธัะตัะบะพะน ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ, ัะพััะฐะฝัั ะฒัะตะผั ะธะฝัะตัะตะฝัะฐ ะฟะพััะธ ะปะธะฝะตะนะฝัะผ ะพั ะตั ะดะปะธะฝั.
- **ะกัะฐะฒะฝะตะฝะธะต.** ะยSWA ะฝะตั ะธัะตัะฐัะธะน RoPEโัะตัะบะตะนะปะฐ ะบะฐะบ ะฒยLongRoPE ะธยFlashโAttentionโ2 ะฝะต ััะตะฑัะตั ะดะพะฟ. ะฟะฐััะตะน โ ะพะบะฝะพ ัะตะฐะปะธะทะพะฒะฐะฝะพ ะบะฐะบ ะฟัะพััะพะต ะผะฐัะบะธัะพะฒะฐะฝะธะต.

### 3.3 Rolling Buffer KVโCache

- **ะัะพะฑะปะตะผะฐ.** ะัะธ ะณะตะฝะตัะฐัะธะธ ะดะปะธะฝะพะน \$n\$ ััะฐะดะธัะธะพะฝะฝัะน KVโะบะตั ัะฐัััั \$O(n)\$; ะฝะฐย32k ัะพะบะตะฝะฐั ััะพ ัะพัะฝะธ ะะ ะฝะฐยะบะฐะถะดัะน GPU.
- **ะะตัะตะฝะธะต.** ะะพะปััะตะฒะพะน ะฑััะตั ัะธะบัะธัะพะฒะฐะฝะฝะพะณะพ ัะฐะทะผะตัะฐ \$W\$ยโ ััะฐััะต KV ะฟะตัะตะทะฐะฟะธััะฒะฐัััั ะฟะพยะผะพะดัะปั \$W\$, ะฐยัะดะฒะธะณะธ ะบะพะผะฟะตะฝัะธัััััั ะธะฝะดะตะบัะพะผ ะฒยะผะฐัะบะต ะฒะฝะธะผะฐะฝะธั.
- **ะัะพะณ.** ะญะบะพะฝะพะผะธั VRAM \$\approx8\times\$ ะฟัะธย32k ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ; ัะบะพัะพััั ะฝะตยะฟัะพัะตะดะฐะตั, ั.ะบ. ะพะฑัะฐัะตะฝะธะต ะธะดัั ะฟะพยะฝะตะฟัะตััะฒะฝะพะน ะฟะฐะผััะธ.

### 3.4 Prefillย&ยChunking

- **Prefill.** ะะฐยััะฐะฟะต ยซprompt prefillยป (teacher forcing) ะดะปะธะฝะฝัะน ะทะฐะฟัะพั ะฒัั ัะฐะฒะฝะพ ะฟะพััะตะฑะพะฒะฐะป ะฑั \$O(n^2)\$ ะผะฐััะธั.
- **Chunking.** ะะฐะทะฑะธะฒะฐะตะผ prompt ะฝะฐยัะฐะฝะบะธ ะดะปะธะฝะพะน \$W\$ ะธยะทะฐะณััะถะฐะตะผ ะธั ะฟะพะพัะตััะดะฝะพ, ัะตะธัะฟะพะปัะทัั ะฑััะตั KV.
- **ะฃัะบะพัะตะฝะธะต.** ะะปั 32k prompt ะฟัะตะดะทะฐะฟะพะปะฝะตะฝะธะต ัะพะบัะฐัะฐะตััั ัย\~5ยั ะดะพย<=2ยั ะฝะฐยA100ย80GB.

## 4. ะะฐะฝะฝัะต ะธยะพะฑััะตะฝะธะต

> ะะฒัะพัั ะฝะต ัะฐัะบััะฒะฐัั ะฟะพะปะฝัะน ัะพััะฐะฒ ะดะฐัะฐัะตัะฐ, ะฝะพ ะฟะพะดัััะบะธะฒะฐัั, ััะพ ะธัะฟะพะปัะทะพะฒะฐะฝั ัะพะปัะบะพ ะฟัะฑะปะธัะฝัะต ะบะพัะฟััะฐ. ะะพะดะตะปั ะพะฑััะฐะปะฐัั ยซัยะฝัะปัยป ะฑะตะทยะดะพะพะฑััะตะฝะธั ะฝะฐยะฟัะพะฟัะธะตัะฐัะฝัั ะดะฐะฝะฝัั.

- ะะฟะฟะฐัะฐัะฝะพะต ััะบะพัะตะฝะธะต: *FlashAttentionโฏv2* ะธย*xFormers*.
- ะกััะฐัะตะณะธั *checkpointโaverage* ะดะปัยัะณะปะฐะถะธะฒะฐะฝะธั ะบะพะปะตะฑะฐะฝะธะน ะบะฐัะตััะฒะฐ.
