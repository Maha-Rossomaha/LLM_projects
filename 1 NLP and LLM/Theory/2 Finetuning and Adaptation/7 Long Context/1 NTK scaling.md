# NTK Scaling

**NTK Scaling** ‚Äî —ç—Ç–æ —Ç–µ—Ö–Ω–∏–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–æ–≤ –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –¥–ª–∏–Ω—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (`seq_len`). –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—Ç **Neural Tangent Kernel (NTK)** ‚Äî —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏, –æ–ø–∏—Å—ã–≤–∞—é—â–µ–π –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π –≤ —Ä–µ–∂–∏–º–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π —à–∏—Ä–∏–Ω—ã.

–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –ø–æ–¥ NTK scaling –ø–æ–Ω–∏–º–∞–µ—Ç—Å—è **–Ω–∞–±–æ—Ä –º–µ—Ç–æ–¥–æ–≤, –ø–æ–∑–≤–æ–ª—è—é—â–∏—Ö —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º–∏**.

---

## –ü—Ä–æ–±–ª–µ–º–∞ –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ `seq_len`

–ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ —É–≤–µ–ª–∏—á–∏—Ç—å `context length` –≤ –æ–±—ã—á–Ω–æ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å 2k ‚Üí 32k), –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã:

* Attention —Å—Ö–æ–¥–∏—Ç—Å—è –∫ —Ç—Ä–∏–≤–∏–∞–ª—å–Ω–æ–º—É (—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–º—É –∏–ª–∏ –ø–∏–∫–æ–≤–æ–º—É) —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é.
* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º–∏ (–≤–∑—Ä—ã–≤/–∑–∞—Ç—É—Ö–∞–Ω–∏–µ).
* –ú–æ–¥–µ–ª—å –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –¥–∞–ª—å–Ω–∏–µ —Ç–æ–∫–µ–Ω—ã –∏–ª–∏ –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç –Ω–∞ –¥–ª–∏–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö.

–ü—Ä–∏—á–∏–Ω–∞: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ—Å–æ–≤ –∏ position encoding **–Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ø–æ –¥–ª–∏–Ω–µ**.

---

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç NTK Scaling

NTK scaling –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ä–µ—à–µ–Ω–∏—è:

### 1. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è (RoPE)

Rotary Position Embedding (RoPE) —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å–∏–Ω—É—Å–∞–º–∏, –∑–∞–≤–∏—Å—è—â–∏–º–∏ –æ—Ç –º–∞—Å—à—Ç–∞–±–∞:

$$
\theta_i = \theta_{base}^{-(i / d)}
$$

–î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **NTK-aware RoPE scaling**:

$$
\theta_i = \theta_{base}^{-(i / d) \cdot \text{scaling}}
$$

–≥–¥–µ `scaling > 1.0` –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–¥–≤–∏–Ω—É—Ç—å —á–∞—Å—Ç–æ—Ç—ã –∏ –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ `seq_len >> 2k`.

–ü—Ä–∏–º–µ—Ä –∏–∑ LLaMA 2:

```python
if rope_scaling == "dynamic":
    scale = math.log(max_seq_len / base) / math.log(rope_theta)
```

### 2. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏ attention

–í –æ–±—ã—á–Ω–æ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–µ attention –¥–µ–ª–∏—Ç—Å—è –Ω–∞ $\sqrt{d}$ –∏–ª–∏ $d$, –Ω–æ –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–æ–∂–Ω–æ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ:

* –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–µ–ª–∏—Ç–µ–ª—è ‚Äî —É–º–µ–Ω—å—à–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å attention –∫ —Ä–æ—Å—Ç—É –¥–ª–∏–Ω—ã.
* –ò–Ω–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –Ω–æ—Ä–º–∏—Ä–æ–≤–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã.

### 3. –†–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–æ—Å—Ç –¥–ª–∏–Ω—ã

* **Curriculum learning –ø–æ –¥–ª–∏–Ω–µ**: –æ–±—É—á–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 512 –∏–ª–∏ 2k —Ç–æ–∫–µ–Ω–æ–≤), –∏ –ø–æ –º–µ—Ä–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥–µ–ª–∏ –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2k ‚Üí 4k ‚Üí 8k ‚Üí 16k ‚Üí 32k). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–æ–¥–µ–ª–∏ —Å–Ω–∞—á–∞–ª–∞ –≤—ã—É—á–∏—Ç—å –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –Ω–∞ –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö –∏ –∏–∑–±–µ–∂–∞—Ç—å –≤–∑—Ä—ã–≤–æ–≤ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤.

* **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª–∏–Ω—ã (length scheduler)**: –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —á–∏—Å–ª—É —à–∞–≥–æ–≤ –∏–ª–∏ —ç–ø–æ—Ö, –ª–∏–±–æ –∫ –∫–∞—á–µ—Å—Ç–≤—É –º–æ–¥–µ–ª–∏ (–µ—Å–ª–∏ loss < threshold, —É–≤–µ–ª–∏—á–∏—Ç—å `max_seq_len`).

* **–†–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è –ø–æ —Ç–æ–∫–µ–Ω—É**: –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å DropToken, Masking, –∏–ª–∏ Loss Scaling –¥–ª—è –¥–∞–ª—å–Ω–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤, —á—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –±–ª–∏–∑–∫–∏–µ –∏ —É–ª—É—á—à–∏—Ç—å –æ–±–æ–±—â–∞—é—â—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å.

* **–°—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤**: —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –¥–ª–∏–Ω—ã –ø–æ–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç–∏ –±–∞—Ç—á–∞ –∏–ª–∏ —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é ‚Äî —ç—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç –ø–∞–º—è—Ç—å –∏ —É—Å–∫–æ—Ä—è–µ—Ç –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–Ω–Ω–∏—Ö —ç—Ç–∞–ø–∞—Ö.

* –¢–∞–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ –æ—Å–æ–±–µ–Ω–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã –≤ —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å **FlashAttention**, **gradient checkpointing** –∏ **activation offloading**, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç —É–º–µ—Å—Ç–∏—Ç—å –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—É—é –ø–∞–º—è—Ç—å.

### 4. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–µ—Å–æ–≤

* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è attention-–º–∞—Ç—Ä–∏—Ü —Å —É—á–µ—Ç–æ–º `seq_len`, —á—Ç–æ–±—ã variance –±—ã–ª–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π.
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–æ—Ä–∏–∏ NTK.

---

## –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

| –ú–æ–¥–µ–ª—å       | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ NTK Scaling                         |
| ------------ | ---------------------------------------------- |
| **LLaMA 2**  | NTK-aware rotary embeddings + FlashAttention   |
| **LongChat** | NTK scaling + rope + sliding window            |
| **Yi**       | rotary with NTK + linear interpolation         |
| **Mistral**  | –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–∏ + Flash + –ø–æ–¥–¥–µ—Ä–∂–∫–∞ long context |
| **Claude**   | –ø—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ NTK            |

---

## –í—ã–≤–æ–¥

**NTK Scaling** ‚Äî —ç—Ç–æ –Ω–∞–±–æ—Ä —Ç–µ—Ö–Ω–∏–∫ (–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ RoPE, –∞–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è), –∫–æ—Ç–æ—Ä—ã–µ **–ø–æ–∑–≤–æ–ª—è—é—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏** –≤ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–∞—Ö.

–ë–µ–∑ —ç—Ç–æ–≥–æ –ø—Ä–∏ `context_length > 4k` –æ–±—É—á–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º, –∞ attention ‚Äî –Ω–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º.

> üí° NTK Scaling ‚Äî —ç—Ç–æ –Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç—Ä—é–∫, –∞ –Ω–∞–±–æ—Ä –ø—Ä–∏—ë–º–æ–≤ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –æ–±—É—á–µ–Ω–∏—è –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö `seq_len`.
