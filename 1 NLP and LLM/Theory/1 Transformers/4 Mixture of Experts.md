# –ö–æ–Ω—Å–ø–µ–∫—Ç ¬´Mixture of Experts (MoE)¬ª  
URL:  
üîó [Mixture of Experts Explained](https://huggingface.co/blog/moe)  
üîó [A Visual Guide to MoE](https://newsletter.maartengrootendorst.com/p/a-visual-guide-to-mixture-of-experts)  
üîó [Understanding Mixture of Experts: Building a MoE Model with PyTorch](https://medium.com/@prateeksikdar/understanding-mixture-of-experts-building-a-moe-model-with-pytorch-dd373d9db81c)

> **–ö–æ—Ä–æ—Ç–∫–æ:** MoE¬†‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± ¬´—Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω–æ–≥–æ¬ª –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–æ–≤: –∫–∞–∂–¥—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à–æ–π –ø–æ–¥‚Äë–Ω–∞–±–æ—Ä *—ç–∫—Å–ø–µ—Ä—Ç–æ–≤* (—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö FFN‚Äë–≤–µ—Ç–æ–∫), –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö *—Ä–æ—É—Ç–µ—Ä–æ–º*. –ë–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–º—É –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤¬†‚Äî –≤—Å–µ–≥–æ 10‚Äì20‚ÄØ% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞, —á—Ç–æ –¥–∞—ë—Ç –ø–æ—á—Ç–∏ –ª–∏–Ω–µ–π–Ω—É—é —ç–∫–æ–Ω–æ–º–∏—é FLOP –±–µ–∑ —É—Ö—É–¥—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞.  

---

## 1. –°—É—Ç—å –∏–¥–µ–∏  
* –ü–ª–æ—Ç–Ω–∞—è LLM —Ç—Ä–∞—Ç–∏—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∫–∞–∂–¥–æ–º —Å–ª–æ–µ.  
* –í¬†MoE‚Äë—Å–ª–æ–µ –µ—Å—Ç—å $E$ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö **—ç–∫—Å–ø–µ—Ä—Ç–æ–≤**; —Ä–æ—É—Ç–µ—Ä –æ—Ü–µ–Ω–∫–æ–π $p_i$ –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–æ–ø‚Äë$k$ (–æ–±—ã—á–Ω–æ¬†1‚Äì2) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞.   
* –í –∏—Ç–æ–≥–µ –Ω–∞ —Ç–æ–∫–µ–Ω –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ª–∏—à—å $\frac{k}{E}$ —á–∞—Å—Ç–∏ –≤–µ—Å–∞, –Ω–æ —Å—É–º–º–∞—Ä–Ω–∞—è ¬´–ø–∞–º—è—Ç—å¬ª –º–æ–¥–µ–ª–∏ —Ä–∞—Å—Ç—ë—Ç –ª–∏–Ω–µ–π–Ω–æ —Å —á–∏—Å–ª–æ–º —ç–∫—Å–ø–µ—Ä—Ç–æ–≤.  

---

## 2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã  

### 2.1 –≠–∫—Å–ø–µ—Ä—Ç—ã  
–ö–∞–∂–¥—ã–π —ç–∫—Å–ø–µ—Ä—Ç¬†‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π FFN —Å–æ SwiGLU (–∏–ª–∏ ReLU), –Ω–æ –æ–±—É—á–∞–µ—Ç—Å—è –Ω–∞ *–ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ* —Ç–æ–∫–µ–Ω–æ–≤, —Ñ–æ—Ä–º–∏—Ä—É—è ¬´—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é¬ª (–∫–æ–¥, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –¥–∏–∞–ª–æ–≥–∏).  

### 2.2 –†–æ—É—Ç–µ—Ä  
* –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è (softmax –ø–æ $E$) –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –≤—ã–±–æ—Ä–∞ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤.  
* –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è *Top‚Äëk* –æ–±—Ä–µ–∑–∫–∞ (–æ–±—ã—á–Ω–æ $k=2$) + *capacity factor* —á—Ç–æ–±—ã –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –æ—á–µ—Ä–µ–¥—å —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ —ç–∫—Å–ø–µ—Ä—Ç–∞ –∏ –∏–∑–±–µ–∂–∞—Ç—å ¬´–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è¬ª.   

### 2.3 –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –ª–æ—Å—Å—ã  
* **Load‚Äëbalancing loss**: –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–æ—É—Ç–µ—Ä —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ç–æ–∫–µ–Ω—ã, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—è –¥–∏—Å–ø–µ—Ä—Å–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.  
* **Z‚Äëloss / Entropy loss**: —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, —Å–Ω–∏–∂–∞—è ¬´–º—ë—Ä—Ç–≤—ã—Ö¬ª —ç–∫—Å–ø–µ—Ä—Ç–æ–≤.   

---

## 3. –û–±—É—á–µ–Ω–∏–µ  

| –≠—Ç–∞–ø | –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç | –°–ª–æ–∂–Ω–æ—Å—Ç—å |  
|------|----------------|-----------|  
| Pre‚Äëtrain | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π next‚Äëtoken loss + aux‚Äëbalance | –¢—Ä–µ–±—É–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä NCCL‚Äëfriendly (–º–Ω–æ–≥–æ all‚Äëto‚Äëall)  |  
| Fine‚Äëtune | –ú–æ–∂–Ω–æ ¬´–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—Ç—å¬ª —ç–∫—Å–ø–µ—Ä—Ç—ã –∏ –æ–±—É—á–∞—Ç—å —Ä–æ—É—Ç–µ—Ä, –ø–æ–ª—É—á–∞—è –ª—ë–≥–∫—É—é –∞–¥–∞–ø—Ç–∞—Ü–∏—é |  |  
| Distillation | Dense‚Äë—Å—Ç—É–¥–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 7B) –ø–æ–≥–ª–æ—â–∞–µ—Ç –∑–Ω–∞–Ω–∏—è MoE‚Äë—É—á–∏—Ç–µ–ª—è | –°–Ω–∏–∂–∞–µ—Ç latency –Ω–∞ inference  |  

---

## 4. –ü–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã  

| –ü–ª—é—Å—ã | –ú–∏–Ω—É—Å—ã |  
|-------|--------|  
| $\sim10\times$ –±–æ–ª—å—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ¬´–≤ –ø–∞–º—è—Ç–∏¬ª –ø—Ä–∏ —Ç–æ–º –∂–µ FLOP | –°–ª–æ–∂–Ω—ã–π all‚Äëto‚Äëall ‚Üí —Å–µ—Ç–µ–≤–æ–π bottleneck |  
| –õ–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—è —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ | ¬´–ò–≥—Ä–∞¬ª —Å capacity‚Äëfactor –∏–Ω–∞—á–µ —Ç–æ–∫–µ–Ω—ã –¥—Ä–æ–ø–∞—é—Ç—Å—è  |  
| –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ —É–ª—É—á—à–∞–µ—Ç zero‚Äëshot reasoning | –°–ª–æ–∂–Ω–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å —á–µ–∫–ø–æ–π–Ω—Ç—ã (ROUTER seed) |  
| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≥–∏–±—Ä–∏–¥–Ω—ã—Ö –∑–∞–¥–∞—á (–≤–∏–∑—É–∞–ª/—Ç–µ–∫—Å—Ç) —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω—ã–µ –ø—É–ª—ã —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ | |  

–°—É—Ç—å **Capacity factor** –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ Mixture of Experts (MoE) –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–º –±—É—Ñ–µ—Ä–∞, –∏–ª–∏ ¬´—ë–º–∫–æ—Å—Ç–∏¬ª, –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞. –ö–∞–∂–¥—ã–π —ç–∫—Å–ø–µ—Ä—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∑–∞ –ø–∞—Ä—Ç–∏—é.  
–ï—Å–ª–∏ Capacity factor —Ä–∞–≤–µ–Ω 1, —Ç–æ –±—É—Ñ–µ—Ä –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤. –ù–∞–ø—Ä–∏–º–µ—Ä, –∑–Ω–∞—á–µ–Ω–∏–µ 1,25 –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±—É—Ñ–µ—Ä –≤ 25%, –ø–æ–∑–≤–æ–ª—è—è –∫–∞–∂–¥–æ–º—É —ç–∫—Å–ø–µ—Ä—Ç—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞ 25% –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤, —á–µ–º –≤ —Å—Ä–µ–¥–Ω–µ–º –ø–æ –ø–∞—Ä—Ç–∏–∏.  
–í—ã–±–æ—Ä Capacity factor —Å–≤—è–∑–∞–Ω —Å –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–æ–º:
- **–ù–∏–∑–∫–∏–π Capacity factor (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1,0)**. –ï—Å–ª–∏ –±—É—Ñ–µ—Ä —ç–∫—Å–ø–µ—Ä—Ç–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π, –æ–Ω –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤, —á–µ–º –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å. –¢–æ–∫–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —ç–∫—Å–ø–µ—Ä—Ç–æ–º. –≠—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è, –Ω–æ —Å–Ω–∏–∂–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ —Ç–µ—Ä—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –∫ —ç—Ç–∏–º —Ç–æ–∫–µ–Ω–∞–º.
- **–í—ã—Å–æ–∫–∏–π Capacity factor (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2,0)**. –ë–æ–ª—å—à–æ–π –±—É—Ñ–µ—Ä –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –æ—Ç–±—Ä–∞—Å—ã–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤. –û–¥–Ω–∞–∫–æ –æ–Ω –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º—É –≤—ã–¥–µ–ª—è—Ç—å –ø–∞–º—è—Ç—å –∏ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è —ë–º–∫–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –≠—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ –∏ –∑–∞–º–µ–¥–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.  

---

## 5. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã (–∏–∑ —Å—Ç–∞—Ç–µ–π)  
1. **k=1 vs k=2**: –æ–¥–∏–Ω —ç–∫—Å–ø–µ—Ä—Ç –±—ã—Å—Ç—Ä–µ–µ –∏ –ø—Ä–æ—â–µ, –¥–≤–∞¬†‚Äî –≤—ã—à–µ –∫–∞—á–µ—Å—Ç–≤–æ, –Ω–æ —É–¥–≤–∞–∏–≤–∞–µ—Ç –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é.   
2. **Capacity factor¬†1.25**¬†‚Äî —ç–º–ø–∏—Ä–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–π.   
3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ **FP8 / INT4** –∫ –∞–∫—Ç–∏–≤–Ω—ã–º –≤–µ—Å–∞–º –¥–∞—ë—Ç –≤—ã–∏–≥—Ä—ã—à –≤ –ø–∞–º—è—Ç–∏ –±–µ–∑ –∑–∞–º–µ—Ç–Ω–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏.   
4. –ù–∞ inference –º–æ–∂–Ω–æ ¬´–∑–∞–∫—ç—à–∏—Ä–æ–≤–∞—Ç—å¬ª —Ä–æ—É—Ç–µ—Ä‚Äë–≤—ã–±–æ—Ä –¥–ª—è —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤, —Å–Ω–∏–∂–∞—è latency.   

---

## 6. –ö–ª—é—á–µ–≤—ã–µ —Ñ–æ—Ä–º—É–ª—ã  

**–†–æ—É—Ç‚Äë–ª–æ–≥–∏—Ç—ã:** $z = W_r h$  

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏:** $p = \text{softmax}(z)$  

**Top‚Äëk mask:**  
$$m_i = \begin{cases}1, & p_i \in \text{top‚Äëk}\\0,&\text{–∏–Ω–∞—á–µ}\end{cases}$$  

**Load‚Äëbalancing loss:**  
$$L_{lb} = E \sum_j q_j \log q_j,\quad q_j = \frac{n_j}{\sum_k n_k}$$  

–≥–¥–µ $n_j$ ‚Äî —á–∏—Å–ª–æ —Ç–æ–∫–µ–Ω–æ–≤, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫ —ç–∫—Å–ø–µ—Ä—Ç—É¬†$j$.   

---

## 7. –†–µ—Ü–µ–ø—Ç ¬´–ú–∏–Ω–∏‚ÄëMoE¬ª (–ø–æ Medium)  

### 2.1 4 —à–∞–≥–∞ –∫ —Ä–∞–±–æ—á–µ–º—É –±–ª–æ–∫—É  
1. **–≠–∫—Å–ø–µ—Ä—Ç—ã**: N¬†–ª–∏–Ω–µ–π–Ω—ã—Ö FFN‚Äë–≤–µ—Ç–æ–∫ —Å SwiGLU.   
2. **–ì–µ–π—Ç**: $p=\text{softmax}(W_r h)$, –≤—ã–±–∏—Ä–∞–µ–º —Ç–æ–ø‚Äë$k=2$, –ø—Ä–∏–º–µ–Ω—è–µ–º capacity‚Äëfactor¬†1.25.  
3. **–°–±–æ—Ä–∫–∞**: —Ä–∞—Å—Å—ã–ª–∞–µ–º —Ç–æ–∫–µ–Ω—ã –ø–æ —ç–∫—Å–ø–µ—Ä—Ç–∞–º (scatter) ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ‚Üí —Å–æ–±–∏—Ä–∞–µ–º (gather).  
4. **Aux‚Äëloss**: load‚Äëbalancing + —ç–Ω—Ç—Ä–æ–ø–∏—è, —á—Ç–æ–±—ã —ç–∫—Å–ø–µ—Ä—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ.   

### 2.2 –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞   
```python
import torch, torch.nn as nn
import torch.nn.functional as F

class FFN(nn.Module):
    """
    –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π FFN-–±–ª–æ–∫ Transformer-–¥–µ–∫–æ–¥–µ—Ä–∞ (SwiGLU –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).
    """
    def __init__(self, d_model: int, d_ff: int):
        super().__init__()
        self.w1   = nn.Linear(d_model, d_ff * 2) # ‚Üí2√ó –¥–ª—è SwiGLU
        self.w2   = nn.Linear(d_ff, d_model)

    def forward(self, x):
        a, b = self.w1(x).chunk(2, dim=-1) # SwiGLU
        return self.w2(F.silu(a) * b)


class MoEBlock(nn.Module):
    """
    Mixture-of-Experts-—Å–ª–æ–π (Top-k Gating) –±–µ–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ all-to-all,
    –ø—Ä–∏–≥–æ–¥–Ω—ã–π –¥–ª—è CPU / –æ–¥–Ω–æ–π GPU. –í DeepSpeed —ç—Ç–∞ –ª–æ–≥–∏–∫–∞ ¬´–∑–∞—à–∏—Ç–∞¬ª –≤ CUDA-—è–¥—Ä–∞.
    """
    def __init__(
        self,
        d_model:   int  = 4096,
        d_ff:      int  = 14336,
        experts:   int  = 16,
        top_k:     int  = 2,
        capacity:  float = 1.25, # –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç ¬´—ë–º–∫–æ—Å—Ç–∏¬ª —ç–∫—Å–ø–µ—Ä—Ç–∞
    ):
        super().__init__()
        self.top_k      = top_k
        self.experts    = nn.ModuleList([FFN(d_model, d_ff) for _ in range(experts)])
        self.router     = nn.Linear(d_model, experts, bias=False)
        self.capacity   = capacity

        # –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è auxiliary load-balance loss
        self.register_buffer("decay", torch.tensor(0.9))

    def forward(self, x):
        """
        x: [batch, seq, d_model]
        """
        B, S, D = x.shape
        E       = len(self.experts)
        tokens  = x.view(-1, D) # ‚Üí [B¬∑S, d_model]

        # 1) Gating: –æ—Ü–µ–Ω–∫–∏ –≤–∞–∂–Ω–æ—Å—Ç–∏ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤
        logits   = self.router(tokens) # [B¬∑S, E]
        scores   = F.softmax(logits, dim=-1)

        # 2) Top-k –≤—ã–±–æ—Ä –∏ –∏–Ω–¥–µ–∫—Å—ã —ç–∫—Å–ø–µ—Ä—Ç–æ–≤
        topk_val, topk_idx = torch.topk(scores, self.top_k, dim=-1) # [B¬∑S, k]

        # 3) Capacity ‚Äì —Å–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å —ç–∫—Å–ø–µ—Ä—Ç
        cap = int(self.capacity * (B * S) / E)

        # 4) –§–æ—Ä–º–∏—Ä—É–µ–º *dispatch*-–º–∞—Å–∫—É (one-hot –ø–æ —Ç–æ–ø-k) –∏ —Å—á–∏—Ç–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        dispatch = torch.zeros(B * S, E, device=x.device)
        for i in range(self.top_k):
            idx = topk_idx[:, i]
            mask = (
                torch.arange(cap, device=x.device)[None, :] # [1, cap]
                < torch.bincount(idx, minlength=E)[idx][:, None]
            )
            dispatch.scatter_(1, idx.unsqueeze(-1), mask.float())

        # 5) –†–∞—Å—Å—ã–ª–∞–µ–º —Ç–æ–∫–µ–Ω—ã –∫ —ç–∫—Å–ø–µ—Ä—Ç–∞–º
        expert_inputs = [
            tokens[dispatch[:, e].bool()] for e in range(E) # variable length
        ]
        expert_outputs = [
            self.experts[e](inp) if len(inp) else torch.empty_like(inp)
            for e, inp in enumerate(expert_inputs)
        ]

        # 6) –û–±—Ä–∞—Ç–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è (gather) —Å –≤–µ—Å–∞–º–∏ —Ç–æ–ø-k-–æ—Ü–µ–Ω–æ–∫
        output = torch.zeros_like(tokens)
        for e in range(E):
            out   = expert_outputs[e] # [n_e, D]
            sel   = dispatch[:, e].bool()
            output[sel] += out * scores[sel, e:e+1] # –≤–∑–≤–µ—à–∏–≤–∞–µ–º –ø–æ softmax-–æ—Ü–µ–Ω–∫–µ

        # 7) –î–æ–ø-–ª–æ—Å—Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ (Routers Auxiliary Loss)
        load = dispatch.mean(0) # –¥–æ–ª—è —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ —ç–∫—Å–ø–µ—Ä—Ç–∞
        prob = scores.mean(0) # —Å—Ä–µ–¥–Ω–µ–µ softmax-p
        aux_loss = (E * (load * prob).sum()) # Fedus et al., 2021

        # —Å–æ—Ö—Ä–∞–Ω—è–µ–º EMA —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        if self.training:
            if not hasattr(self, "aux_ema"):
                self.aux_ema = aux_loss.detach()
            self.aux_ema = self.decay * self.aux_ema + (1 - self.decay) * aux_loss.detach()

        return output.view(B, S, D), aux_loss
```

### 2.3 –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–¥–∞
| –®–∞–≥                   | –ö–æ–¥                                    | –û–±—ä—è—Å–Ω–µ–Ω–∏–µ                                                                                                                                          |
| --------------------- | -------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. Router softmax** | `scores = F.softmax(logits, -1)`       | –õ–∏–Ω–µ–π–Ω—ã–π ¬´–≥–µ–π—Ç¬ª –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å $p_{i}$, —á—Ç–æ —Ç–æ–∫–µ–Ω –ø–æ–π–¥—ë—Ç –∫ —ç–∫—Å–ø–µ—Ä—Ç—É $i$.                                                               |
| **2. Top-k –≤—ã–±–æ—Ä**    | `topk_val, topk_idx = torch.topk(...)` | –û—Ç–±–∏—Ä–∞–µ–º $k$ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º $p$ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞. –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è $k=1$ –∏–ª–∏ $k=2$ ‚Äî –∫–æ–º–ø—Ä–æ–º–∏—Å—Å ¬´–∫–∞—á–µ—Å—Ç–≤–æ vs –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏¬ª. |
| **3. Capacity**       | `cap = int(self.capacity * N / E)`     | –ö–∞–∂–¥—ã–π —ç–∫—Å–ø–µ—Ä—Ç –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –Ω–µ –±–æ–ª–µ–µ *capacity factor* √ó —Å—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ —Ç–æ–∫–µ–Ω–æ–≤. DeepSpeed-MoE –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1.25.                                    |
| **4. Dispatch mask**  | `dispatch.scatter_`                    | One-hot-—Ç–µ–Ω–∑–æ—Ä `[N, E]` —É–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–æ–π —Ç–æ–∫–µ–Ω –∫ –∫–∞–∫–æ–º—É —ç–∫—Å–ø–µ—Ä—Ç—É –ø–æ–π–¥—ë—Ç ‚Äî –∞–Ω–∞–ª–æ–≥ CUDA-kernel `dhs_dispatch` –≤ DeepSpeed.                           |
| **5. Scatter**        | `expert_inputs = [‚Ä¶]`                  | –†–∞–∑–¥–µ–ª—è–µ–º –≤—Ö–æ–¥—ã –ø–æ —ç–∫—Å–ø–µ—Ä—Ç–∞–º; –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —ç—Ç–æ *all-to-all* MPI-–æ–ø–µ—Ä–∞—Ü–∏—è.                                                               |
| **6. Gather**         | `output[sel] += out * weight`          | –û–±—Ä–∞—Ç–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤, –≤–∑–≤–µ—à–µ–Ω–Ω–∞—è –ø–æ –∏—Å—Ö–æ–¥–Ω—ã–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º (Switch Transformer trick).                                          |
| **7. Aux loss**       | `aux_loss = (E*(load*prob).sum())`     | **Load-balancing loss** —Å—Ç–∏–º—É–ª–∏—Ä—É–µ—Ç —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è ¬´–≥–æ–ª–æ–¥–∞–Ω–∏–µ¬ª .                                                 |

### 2.4 –ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä forward
#### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
**–í—Ö–æ–¥**: **x** - —Ç–µ–Ω–∑–æ—Ä **[batch, seq_len, d_model]**  
**–î–µ–π—Å—Ç–≤–∏–µ**:
1. –¢–æ–∫–µ–Ω—ã "—Ä–∞–∑–≥–ª–∞–∂–∏–≤–∞—é—Ç—Å—è" –≤ **[B*S, D]** (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–∏–º–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ).
2. –†–æ—É—Ç–µ—Ä **(self.router)** –≤—ã—á–∏—Å–ª—è–µ—Ç –ª–æ–≥–∏—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞:
```python
logits = self.router(tokens)  # [B*S, E]
scores = F.softmax(logits, dim=-1)  # –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∞ –≤ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
```  

**–í—ã—Ö–æ–¥**:  
**scores** ‚Äî –º–∞—Ç—Ä–∏—Ü–∞ **[B*S, E]**, –≥–¥–µ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –≤—ã–±–æ—Ä–∞ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –¥–ª—è —Ç–æ–∫–µ–Ω–∞.  
  
**–ó–∞—á–µ–º –Ω—É–∂–Ω–æ**:  
–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ —ç–∫—Å–ø–µ—Ä—Ç—ã –ª—É—á—à–µ –≤—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∂–¥—ã–π —Ç–æ–∫–µ–Ω.

#### –®–∞–≥ 2: –í—ã–±–æ—Ä Top-k —ç–∫—Å–ø–µ—Ä—Ç–æ–≤  
**–î–µ–π—Å—Ç–≤–∏–µ**  
```python
topk_val, topk_idx = torch.topk(scores, self.top_k, dim=-1)  # [B*S, k]
```   
**–í—ã—Ö–æ–¥**:  
- **topk_idx** ‚Äî –∏–Ω–¥–µ–∫—Å—ã **k** —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏.
- **topk_val** ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π.  

**–ó–∞—á–µ–º –Ω—É–∂–Ω–æ**:  
–ö–∞–∂–¥—ã–π —Ç–æ–∫–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ **top_k** —ç–∫—Å–ø–µ—Ä—Ç–∞–º (–∞ –Ω–µ –≤—Å–µ–º), —á—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.


#### –®–∞–≥ 3: –†–∞—Å—á–µ—Ç –µ–º–∫–æ—Å—Ç–∏ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤
**–î–µ–π—Å—Ç–≤–∏–µ**  
```python
cap = int(self.capacity * (B * S) / E)
```   
**–í—ã—Ö–æ–¥**:  
**cap** ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ —Ç–æ–∫–µ–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–∏–Ω —ç–∫—Å–ø–µ—Ä—Ç.  

**–§–æ—Ä–º—É–ª–∞**:  
- **(B * S) / E** ‚Äî —Å—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —ç–∫—Å–ø–µ—Ä—Ç–∞, –µ—Å–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ–∫–µ–Ω—ã —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ.
- **capacity** (–Ω–∞–ø—Ä–∏–º–µ—Ä, **1.25**) –ø–æ–∑–≤–æ–ª—è–µ—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞–º –±—Ä–∞—Ç—å –Ω–∞ **25%** –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤, —á–µ–º –≤ —Å—Ä–µ–¥–Ω–µ–º (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å "–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è" –∏–∑-–∑–∞ –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏).

**–ó–∞—á–µ–º –Ω—É–∂–Ω–æ**:  
–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –µ–º–∫–æ—Å—Ç–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —ç–∫—Å–ø–µ—Ä—Ç—ã –º–æ–≥–ª–∏ –±—ã –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å—Å—è, –∞ –¥—Ä—É–≥–∏–µ ‚Äî –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—Ç—å.

#### –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ dispatch-–º–∞—Å–∫–∏
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –±–ª–æ–∫ –∫–æ–¥–∞?**  
–û–Ω —Å–æ–∑–¥–∞—ë—Ç –±–∏–Ω–∞—Ä–Ω—É—é –º–∞—Å–∫—É **dispatch**, –∫–æ—Ç–æ—Ä–∞—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç:
- –ö–∞–∫–∏–µ —Ç–æ–∫–µ–Ω—ã –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∫–∞–∫–æ–º—É —ç–∫—Å–ø–µ—Ä—Ç—É.
- –ü—Ä–∏ —ç—Ç–æ–º —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å **(cap)** –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞.
1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å–∫–∏**
```python
dispatch = torch.zeros(B * S, E, device=x.device)
```  
- –°–æ–∑–¥–∞—ë—Ç—Å—è –º–∞—Ç—Ä–∏—Ü–∞ –Ω—É–ª–µ–π —Ä–∞–∑–º–µ—Ä–æ–º **[–∫–æ–ª-–≤–æ_—Ç–æ–∫–µ–Ω–æ–≤, –∫–æ–ª-–≤–æ_—ç–∫—Å–ø–µ—Ä—Ç–æ–≤]**.
- –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã **0** ‚Äî –Ω–∏ –æ–¥–∏–Ω —Ç–æ–∫–µ–Ω –Ω–∏ –∫ –∫–æ–º—É –Ω–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω.
2. **–¶–∏–∫–ª –ø–æ top_k —ç–∫—Å–ø–µ—Ä—Ç–∞–º**
```python
for i in range(self.top_k):
```
3. **–í—ã–±–æ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ k**
```python
idx = topk_idx[:, i]  # [B*S]
```
–≥–¥–µ **idx** ‚Äî —ç—Ç–æ –≤–µ–∫—Ç–æ—Ä, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏–Ω–¥–µ–∫—Å —ç–∫—Å–ø–µ—Ä—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –≤ —Ç–µ–∫—É—â–µ–º **top-k** —Å–ª–æ—Ç–µ.  
4. **–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è**
```python
mask = (
    torch.arange(cap, device=x.device)[None, :]  # [1, cap]
    < torch.bincount(idx, minlength=E)[idx][:, None]  # [B*S, 1]
)
```  

- **torch.arange(cap)[None, :]**
    - –°–æ–∑–¥–∞—ë—Ç—Å—è –≤–µ–∫—Ç–æ—Ä **[0, 1, 2, ..., cap-1]** –∏ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –¥–æ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ **[1, cap]**.
    - –≠—Ç–æ —à–∞–±–ª–æ–Ω –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ‚Äî –º—ã –±—É–¥–µ–º —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –µ–≥–æ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–æ–∫–µ–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã —ç–∫—Å–ø–µ—Ä—Ç—É.  
- **torch.bincount(idx, minlength=E)**
    - –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –µ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞.
    - –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ **bincount = [0, 2, 1]** –∏ **idx = [1, 1, 2]**, —Ç–æ –ø–æ–ª—É—á–∏–º **[2, 2, 1]**.
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ <
    - –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º **[1, cap]** (—à–∞–±–ª–æ–Ω –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) —Å **[B*S, 1]** (–Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —ç–∫—Å–ø–µ—Ä—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞).
    - –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –º–∞—Å–∫–∞ **[B*S, cap]**, –≥–¥–µ:
        - **mask[j, m] = True**, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω **j** –º–æ–∂–µ—Ç –±—ã—Ç—å **m-—ã–º** –ø–æ —Å—á—ë—Ç—É —É —Å–≤–æ–µ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞.
        - –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —ç–∫—Å–ø–µ—Ä—Ç –Ω–µ –ø–æ–ª—É—á–∏—Ç –±–æ–ª—å—à–µ **cap** —Ç–æ–∫–µ–Ω–æ–≤.  
5. **–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ dispatch –º–∞—Å–∫–∏**  
```python
dispatch.scatter_(1, idx.unsqueeze(-1), mask.float())
```  
- **idx.unsqueeze(-1)** ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç **[B*S]** –≤ **[B*S, 1]** (—á—Ç–æ–±—ã —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å—é dispatch).
- **mask.float()** ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –±—É–ª–µ–≤—É –º–∞—Å–∫—É –≤ **0.0** –∏–ª–∏ **1.0**.
- **scatter_** ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ **j** –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç **mask[j]** –≤ —Å—Ç—Ä–æ–∫—É **dispatch[j]** –ø–æ –∏–Ω–¥–µ–∫—Å—É **idx[j]**  
**–ü—Ä–∏–º–µ—Ä**:
- –ü—É—Å—Ç—å **idx = [1, 1, 2]**, –∞ **mask = [[1, 0], [1, 0], [1, 1]]**.
- –¢–æ–≥–¥–∞:
    - –¢–æ–∫–µ–Ω 0: **dispatch[0, 1] = [1, 0]** (–º–æ–∂–µ—Ç –±—ã—Ç—å 1-–º —É —ç–∫—Å–ø–µ—Ä—Ç–∞ 1, –Ω–æ –Ω–µ 2-–º).
    - –¢–æ–∫–µ–Ω 1: **dispatch[1, 1] = [1, 0]** (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ).
    - –¢–æ–∫–µ–Ω 2: **dispatch[2, 2] = [1, 1]** (–º–æ–∂–µ—Ç –±—ã—Ç—å –∏ 1-–º, –∏ 2-–º —É —ç–∫—Å–ø–µ—Ä—Ç–∞ 2).

**–ò—Ç–æ–≥: —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å –≤ dispatch?**  
- –≠—Ç–æ –±–∏–Ω–∞—Ä–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ **[B*S, E, cap]** (–Ω–æ –≤ –∫–æ–¥–µ –æ–Ω–∞ "—Å—Ö–ª–æ–ø–Ω—É—Ç–∞" –≤ **[B*S, E]**).
- **dispatch[j, e] = 1** –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ç–æ–∫–µ–Ω **j** –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω —ç–∫—Å–ø–µ—Ä—Ç–æ–º **e**.
- –ü—Ä–∏ —ç—Ç–æ–º –Ω–∏–∫–∞–∫–æ–π —ç–∫—Å–ø–µ—Ä—Ç –Ω–µ –ø–æ–ª—É—á–∏—Ç –±–æ–ª—å—à–µ **cap** —Ç–æ–∫–µ–Ω–æ–≤.

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?**  
1. **–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏:** –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–æ—É—Ç–µ—Ä —Ä–µ—à–∏—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –∫ –æ–¥–Ω–æ–º—É —ç–∫—Å–ø–µ—Ä—Ç—É, **cap** –æ–≥—Ä–∞–Ω–∏—á–∏—Ç –∏—Ö —á–∏—Å–ª–æ.
2. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è, —á—Ç–æ —ç–∫—Å–ø–µ—Ä—Ç—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω—ã (–≤–∞–∂–Ω–æ –¥–ª—è GPU/CPU –±–µ–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏).
3. **–î–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º**: –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º MoE), –∑–¥–µ—Å—å —á—ë—Ç–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –∑–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º.

